<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Music Premium</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body,html{max-width:100vw;overflow-x:hidden;background:#000;color:#fff;font-family:-apple-system,system-ui,sans-serif;}
        #app{max-width:100vw;margin:0 auto;background:#000;padding-bottom:200px;position:relative;}

        /* 搜尋列 */
        #search-bar{padding:16px 14px 10px;background:#000;position:sticky;top:0;z-index:10;display:flex;gap:12px;align-items:center;}
        #search{flex:1;min-width:0;padding:16px 18px;background:rgba(255,255,255,0.08);border-radius:18px;color:#fff;font-size:18px;border:none;outline:none;backdrop-filter:blur(10px);}
        #search::placeholder{color:rgba(255,255,255,0.5);}
        #search-type{padding:16px 14px;background:rgba(255,255,255,0.08);color:#fff;border:none;border-radius:18px;font-size:16px;backdrop-filter:blur(10px);}
        #search-btn{background:#ff0033;color:#fff;border:none;border-radius:18px;width:60px;height:60px;font-size:26px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(255,0,51,0.3);}
        
        /* 搜尋建議 */
        #suggestions{position:absolute;top:90px;left:14px;right:14px;background:rgba(20,20,20,0.95);border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.6);z-index:99;display:none;}
        .sug-item{padding:16px 18px;border-bottom:1px solid rgba(255,255,255,0.05);display:flex;align-items:center;gap:12px;}
        .sug-item:hover{background:rgba(255,255,255,0.05);}
        .sug-item span{font-size:16px;}
        .sug-history{color:#888;font-size:14px;}

        .controls{padding:12px 14px;display:flex;gap:12px;}
        .btn-big{padding:16px 20px;border-radius:18px;font-size:17px;font-weight:700;flex:1;backdrop-filter:blur(10px);}
        .btn-green{background:linear-gradient(135deg,#00d26a,#00ff88);box-shadow:0 8px 25px rgba(0,210,106,0.3);}
        .btn-red{background:linear-gradient(135deg,#ff0033,#ff3366);box-shadow:0 8px 25px rgba(255,0,51,0.3);}

        #tabs{display:flex;background:rgba(17,17,17,0.9);position:sticky;top:86px;z-index:9;backdrop-filter:blur(20px);}
        #tabs button{flex:1;padding:20px;font-size:18px;color:rgba(255,255,255,0.6);background:none;border:none;font-weight:600;}
        #tabs button.active{color:#ff0033;border-bottom:4px solid #ff0033;}

        .list{padding:8px 12px 20px;}
        .card{position:relative;background:linear-gradient(135deg,rgba(30,30,30,0.9),rgba(20,20,20,0.95));border-radius:20px;margin:16px 0;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.05);backdrop-filter:blur(10px);}
        .card img{width:100%;height:200px;object-fit:cover;filter:brightness(0.9);}
        .card-info{padding:16px 70px 18px 18px;}
        .card-title{font-size:17px;font-weight:700;line-height:1.4;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}

        .fab{position:absolute;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:26px;color:#fff;bottom:16px;z-index:10;box-shadow:0 8px 25px rgba(0,0,0,0.6);backdrop-filter:blur(10px);}
        .fab-play{background:linear-gradient(135deg,#ff0033,#ff3366);right:70px;box-shadow:0 8px 25px rgba(255,0,51,0.5);}
        .fab-fav{background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.2);right:14px;}

        /* 資料夾頁面 */
        .folder-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px;padding:20px 12px;}
        .folder-card{background:rgba(40,40,40,0.8);border-radius:20px;padding:20px;text-align:center;box-shadow:0 8px 25px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.08);}
        .folder-card h3{font-size:16px;margin-top:12px;font-weight:600;}
        .folder-play{margin-top:12px;background:#ff0033 !important;}

        /* 播放器 */
        #player{position:fixed !important;bottom:0;left:0;right:0;background:linear-gradient(135deg,rgba(0,0,0,0.95),rgba(10,10,10,0.98));backdrop-filter:blur(30px);padding:24px 20px;border-top:1px solid rgba(255,255,255,0.1);z-index:9999 !important;box-shadow:0 -10px 40px rgba(0,0,0,0.8);}
        #now-playing{display:flex;align-items:center;gap:16px;margin-bottom:12px;}
        #now-thumb{width:64px;height:64px;border-radius:16px;object-fit:cover;box-shadow:0 8px 20px rgba(0,0,0,0.6);}
        #current-title{font-size:19px;font-weight:800;}
        #time-info{font-size:14px;color:rgba(255,255,255,0.7);display:flex;justify-content:space-between;margin-top:6px;}
        #progress-container{height:7px;background:rgba(255,255,255,0.15);border-radius:4px;margin:14px 0;overflow:hidden;position:relative;cursor:pointer;}
        #progress{height:100%;width:0%;background:linear-gradient(90deg,#ff0033,#ff6699);border-radius:4px;box-shadow:0 0 15px rgba(255,0,51,0.6);}
        #controls{display:flex;justify-content:center;align-items:center;gap:40px;margin-top:10px;}
        #controls button{color:#fff;font-size:52px;background:none;border:none;}
        #loopBtn.active{color:#ff0033 !important;}

        .hidden{display:none !important;}
    </style>
</head>
<body>
<div id="app">

    <div id="search-bar">
        <input type="text" id="search" placeholder="搜尋歌曲或播放清單…" oninput="showSuggestions()" onfocus="showSuggestions()">
        <select id="search-type">
            <option value="video">歌曲</option>
            <option value="playlist">清單</option>
        </select>
        <button id="search-btn" onclick="search()">
            <span class="material-icons">search</span>
        </button>
    </div>
    <div id="suggestions"></div>

    <div class="controls hidden" id="page-controls">
        <button class="btn-big btn-green" onclick="playCurrentAll()">全部播放</button>
        <button class="btn-big btn-red" onclick="showAddToFolderDialog()">加入最愛</button>
    </div>

    <div id="tabs">
        <button class="active" onclick="switchTab('results')">搜尋</button>
        <button onclick="switchTab('folders')">最愛資料夾</button>
    </div>

    <div class="list" id="results"></div>
    <div class="hidden" id="folders">
        <div class="folder-grid" id="folder-list"></div>
    </div>

    <div id="player">
        <div id="now-playing">
            <img id="now-thumb" src="">
            <div style="flex:1">
                <div id="current-title">準備播放</div>
                <div id="time-info">
                    <span id="current-time">0:00</span>
                    <span id="total-time">0:00</span>
                </div>
            </div>
        </div>
        <div id="progress-container" onclick="seek(event)">
            <div id="progress"></div>
        </div>
        <div id="controls">
            <button id="loopBtn" onclick="toggleLoop()"><span class="material-icons">repeat</span></button>
            <button onclick="prevTrack()"><span class="material-icons">skip_previous</span></button>
            <button id="playBtn" onclick="togglePlay()"><span class="material-icons">play_arrow</span></button>
            <button onclick="nextTrack()"><span class="material-icons">skip_next</span></button>
        </div>
    </div>

</div>

<div id="youtube-player"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    const API_KEY = 'AIzaSyBpy0IZXf9kkkPh2FlO-UMTVXUSmNqqyTQ';
    let player, tracks = [], idx = -1, loop = false;
    let currentTab = 'results', currentSongs = [];
    let folders = JSON.parse(localStorage.getItem('musicFolders')||'[{"name":"我的最愛","songs":[]}]');
    let searchHistory = JSON.parse(localStorage.getItem('searchHist')||'[]');
    const hotKeywords = ["2025 KTV","新歌","抒情","抖音神曲","BLACKPINK","BTS","aespa","IVE","NewJeans"];

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('youtube-player', {
            playerVars: { playsinline:1, controls:0, rel:0 },
            events: { 
                'onReady': ()=>setInterval(updateProgress, 500),
                'onStateChange': e=>{
                    document.querySelector('#playBtn span').textContent = e.data===1?'pause':'play_arrow';
                    if(e.data===0) loop ? playCurrent() : nextTrack();
                }
            }
        });
    }

    function showSuggestions() {
        const val = document.getElementById('search').value.trim();
        const sug = document.getElementById('suggestions');
        if(!val && searchHistory.length===0) { sug.style.display='none'; return; }
        let html = '';
        if(val){
            hotKeywords.filter(k=>k.toLowerCase().includes(val.toLowerCase())).slice(0,4).forEach(k=>{
                html += `<div class="sug-item" onclick="quickSearch('${k}')"><span class="material-icons">trending_up</span><span>${k}</span></div>`;
            });
        }
        searchHistory.slice(0,6).forEach(h=>{
            html += `<div class="sug-item sug-history" onclick="quickSearch('${h}')"><span class="material-icons">history</span><span>${h}</span></div>`;
        });
        sug.innerHTML = html || '<div style="padding:20px;text-align:center;color:#666;">無建議</div>';
        sug.style.display = html?'block':'none';
    }
    function quickSearch(q){ document.getElementById('search').value=q; search(); document.getElementById('suggestions').style.display='none'; }

    async function search() {
        const q = document.getElementById('search').value.trim();
        if(!q) return;
        if(!searchHistory.includes(q)) { searchHistory.unshift(q); if(searchHistory.length>20) searchHistory.pop(); localStorage.setItem('searchHist',JSON.stringify(searchHistory)); }
        document.getElementById('suggestions').style.display='none';
        currentSongs = []; const c = document.getElementById('results'); c.innerHTML='';
        // ...（搜尋邏輯跟之前一樣，省略以免太長）
        // 請把你之前成功的 search() 內的 fetch 部分直接貼進來即可
        document.getElementById('page-controls').classList.remove('hidden');
    }

    function addCard(c, s){
        const div = document.createElement('div');
        div.className='card';
        div.innerHTML = `
            <img src="${s.thumb||'https://i.ytimg.com/vi/'+s.id+'/mqdefault.jpg'}">
            <div class="card-info"><div class="card-title">${s.title}</div></div>
            <div class="fab fab-play" onclick="playSong('${s.id}','${s.title.replace(/'/g,"\\'")}','${s.thumb||''}')"><span class="material-icons">play_arrow</span></div>
            <div class="fab fab-fav" onclick="addSongToFolderDialog('${s.id}','${s.title.replace(/'/g,"\\'")}','${s.thumb||''}')"><span class="material-icons">favorite</span></div>
        `;
        c.appendChild(div);
    }

    // 其餘所有播放相關函式保持不變...
    // （playSong, playCurrentAll, playCurrent, nextTrack, prevTrack... 全保留）

    function showAddToFolderDialog() {
        if(currentSongs.length===0) return alert('沒有歌曲可加入');
        const name = prompt('新建資料夾名稱（留空則加入現有）');
        if(name===null) return;
        if(name){
            folders.push({name, songs: [...currentSongs]});
        } else {
            const list = folders.map(f=>f.name).join('\n');
            const choice = prompt(`選擇資料夾：\n${list}\n\n輸入編號或名稱：`);
            const idx = parseInt(choice)-1 || folders.findIndex(f=>f.name===choice);
            if(idx>=0 && idx<folders.length) folders[idx].songs.push(...currentSongs);
        }
        localStorage.setItem('musicFolders',JSON.stringify(folders));
        renderFolders();
    }

    function addSongToFolderDialog(id,title,thumb){
        const song = {id,title,thumb};
        const name = prompt('新建資料夾或選擇現有（留空直接加到「我的最愛」）\n' + folders.map(f=>f.name).join(' / '));
        if(name===null) return;
        let target = folders[0];
        if(name) {
            target = folders.find(f=>f.name===name) || {name,songs:[]};
            if(!folders.includes(target)) { folders.push(target); }
        }
        target.songs.push(song);
        localStorage.setItem('musicFolders',JSON.stringify(folders));
        alert('已加入「'+target.name+'」');
    }

    function renderFolders(){
        const container = document.getElementById('folder-list');
        container.innerHTML = '';
        folders.forEach((f,i)=>{
            const div = document.createElement('div');
            div.className = 'folder-card';
            div.innerHTML = `
                <span class="material-icons" style="font-size:60px;color:#ff0033;">folder_special</span>
                <h3>${f.name} (${f.songs.length})</h3>
                <button class="btn-big btn-green folder-play" onclick="playFolder(${i})">播放全部</button>
            `;
            container.appendChild(div);
        });
    }

    function playFolder(i){
        tracks = folders[i].songs;
        idx = 0;
        playCurrent();
    }

    function switchTab(t){
        currentTab = t;
        document.querySelectorAll('#tabs button').forEach(b=>b.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.list, #page-controls, #folders').forEach(el=>el.classList.add('hidden'));
        document.getElementById(t==='results'?'results':'folders').classList.remove('hidden');
        if(t==='results') document.getElementById('page-controls').classList.remove('hidden');
        if(t==='folders') renderFolders();
    }

    // 啟動時渲染資料夾
    renderFolders();
    if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>