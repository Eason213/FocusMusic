<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Music</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:-apple-system,sans-serif;background:#000;color:#fff;min-height:100vh;line-height:1.5;}
        #app{max-width:500px;margin:0 auto;background:#000;padding-bottom:140px;}

        /* 搜尋列 */
        #search-bar{padding:16px 16px 12px;background:#000;position:sticky;top:0;z-index:10;}
        #search-input{flex:1;padding:16px;background:#1a1a1a;border:none;border-radius:16px;color:#fff;font-size:18px;}
        #search-type{padding:16px 12px;background:#1a1a1a;color:#fff;border:none;border-radius:16px;font-size:16px;}
        #search-btn{background:#ff0000;color:#fff;padding:16px 24px;border-radius:16px;font-size:24px;}

        /* 控制按鈕 */
        .controls{padding:12px 16px;display:flex;gap:12px;flex-wrap:wrap;}
        .btn-big{padding:14px 24px;border-radius:16px;font-size:17px;font-weight:600;}
        .btn-green{background:#00d26a;color:#fff;}
        .btn-red{background:#ff0000;color:#fff;}

        /* Tabs */
        #tabs{display:flex;background:#111;position:sticky;top:90px;z-index:9;}
        #tabs button{flex:1;padding:18px;font-size:17px;color:#888;background:none;border:none;}
        #tabs button.active{color:#ff0000;border-bottom:4px solid #ff0000;}

        /* 結果卡片 */
        .list{padding:8px 16px;}
        .card{display:flex;align-items:center;padding:16px;background:#111;border-radius:16px;margin-bottom:12px;box-shadow:0 4px 12px rgba(0,0,0,0.3);}
        .card img{width:72px;height:72px;border-radius:12px;object-fit:cover;margin-right:16px;}
        .card-info{flex:1;}
        .card-title{font-size:17px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .card-artist{font-size:14px;color:#aaa;margin-top:4px;}
        .card-actions button{padding:10px 16px;border-radius:12px;font-size:15px;margin-left:8px;}
        .btn-play{background:#ff0000;color:#fff;}
        .btn-fav{background:#333;color:#fff;}

        /* 播放器 */
        #player{position:fixed;bottom:0;left:0;right:0;max-width:500px;margin:0 auto;background:rgba(0,0,0,0.95);backdrop-filter:blur(20px);padding:20px 16px;border-top:1px solid #333;}
        #current-title{font-size:19px;font-weight:600;text-align:center;margin-bottom:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        #progress-container{height:6px;background:#333;border-radius:3px;margin:12px 0;overflow:hidden;cursor:pointer;}
        #progress{height:100%;width:0%;background:#ff0000;border-radius:3px;transition:width 0.2s;}
        #controls{display:flex;justify-content:center;align-items:center;gap:32px;}
        #controls button{color:#fff;font-size:48px;background:none;border:none;width:70px;height:70px;display:flex;align-items:center;justify-content:center;}
        #loopBtn.active{color:#ff0000;}

        #youtube-player{position:fixed;top:-100vh;width:1px;height:1px;opacity:0;}
        .hidden{display:none !important;}
    </style>
</head>
<body>
<div id="app">

    <div id="search-bar" style="display:flex;gap:10px;align-items:center;">
        <input type="text" id="search" placeholder="搜尋歌曲或播放清單…" onkeypress="if(event.key==='Enter')search()">
        <select id="search-type">
            <option value="video">歌曲</option>
            <option value="playlist">清單</option>
        </select>
        <button id="search-btn" onclick="search()">Search</button>
    </div>

    <div class="controls hidden" id="page-controls">
        <button class="btn-big btn-green" onclick="playCurrentAll()">全部播放</button>
        <button class="btn-big btn-red" onclick="addCurrentToFav()">加入最愛</button>
    </div>

    <div id="tabs">
        <button class="active" onclick="switchTab('results')">搜尋</button>
        <button onclick="switchTab('favorites')">最愛</button>
        <button onclick="switchTab('history')">歷史</button>
    </div>

    <div class="list" id="results"></div>
    <div class="list hidden" id="favorites"></div>
    <div class="list hidden" id="history"></div>

    <div id="player">
        <div id="current-title">準備播放</div>
        <div id="progress-container" onclick="seek(event)"><div id="progress"></div></div>
        <div id="controls">
            <button id="loopBtn" onclick="toggleLoop()"><span class="material-icons">repeat</span></button>
            <button onclick="prevTrack()"><span class="material-icons">skip_previous</span></button>
            <button id="playBtn" onclick="togglePlay()"><span class="material-icons">play_arrow</span></button>
            <button onclick="nextTrack()"><span class="material-icons">skip_next</span></button>
        </div>
    </div>

</div>

<div id="youtube-player"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    const API_KEY = 'AIzaSyBpy0IZXf9kkkPh2FlO-UMTVXUSmNqqyTQ'; // 改這一行就好！

    let player, tracks = [], idx = -1, loop = false;
    let currentTab = 'results';
    let currentSongs = [];
    let favorites = JSON.parse(localStorage.getItem('fav')||'[]');
    let history   = JSON.parse(localStorage.getItem('hist')||'[]');

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('youtube-player', {
            playerVars: { playsinline:1, controls:0, rel:0 },
            events: { 'onReady':()=>setInterval(()=>updateProgress(),500), 'onStateChange':e=>{
                document.querySelector('#playBtn span').textContent = e.data===1?'pause':'play_arrow';
                if(e.data===0){
                    if(loop && tracks.length>0){ idx = 0; playCurrent(); }
                    else nextTrack();
                }
            }}
        });
    }

    async function search() {
        const q = document.getElementById('search').value.trim();
        const type = document.getElementById('search-type').value;
        if(!q) return;

        currentSongs = [];
        const ul = document.getElementById('results'); ul.innerHTML = '';

        if(type==='playlist'){
            const res = await fetch(`https://www.googleapis.com/youtube/v3/search?key=${API_KEY}&q=${encodeURIComponent(q)}&part=snippet&type=playlist&maxResults=10`);
            const data = await res.json();
            for(let item of data.items){
                const plId = item.id.playlistId;
                const plRes = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?key=${API_KEY}&playlistId=${plId}&part=snippet&maxResults=50`);
                const plData = await plRes.json();
                plData.items.forEach(p=>{
                    if(p.snippet.title!=='Private video' && p.snippet.resourceId?.videoId){
                        const id = p.snippet.resourceId.videoId;
                        const title = p.snippet.title;
                        currentSongs.push({id,title});
                        addCard(id, title, p.snippet.thumbnails?.medium?.url);
                    }
                });
            }
        } else {
            const res = await fetch(`https://www.googleapis.com/youtube/v3/search?key=${API_KEY}&q=${encodeURIComponent(q)}&part=snippet&type=video&maxResults=30&videoEmbeddable=true`);
            const data = await res.json();
            data.items.forEach(item=>{
                if(item.id?.videoId){
                    const id = item.id.videoId;
                    const title = item.snippet.title;
                    currentSongs.push({id,title});
                    addCard(id, title, item.snippet.thumbnails.medium?.url);
                }
            });
        }
        document.getElementById('page-controls').classList.remove('hidden');
    }

    function addCard(id, title, thumb){
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
            <img src="${thumb||'https://i.ytimg.com/vi/'+id+'/mqdefault.jpg'}">
            <div class="card-info">
                <div class="card-title">${title}</div>
            </div>
            <div class="card-actions">
                <button class="btn-play" onclick="playId('${id}','${title.replace(/'/g,"\\'")}')">播放</button>
                <button class="btn-fav" onclick="addFav('${id}','${title.replace(/'/g,"\\'")}')">Heart</button>
            </div>`;
        document.getElementById('results').appendChild(div);
    }

    function playId(id,title){
        tracks = [{id,title}]; idx = 0;
        playCurrent();
    }

    function playCurrentAll(){
        if(currentSongs.length===0) return;
        tracks = [...currentSongs];
        idx = 0;
        playCurrent();
    }

    function addCurrentToFav(){
        currentSongs.forEach(s=>addFav(s.id,s.title));
    }

    function addFav(id,title){
        if(!favorites.some(f=>f.id===id)){
            favorites.push({id,title});
            localStorage.setItem('fav',JSON.stringify(favorites));
            if(currentTab==='favorites') renderFavorites();
        }
    }

    function playCurrent(){
        const song = tracks[idx];
        document.getElementById('current-title').textContent = song.title;
        addToHistory(song.id, song.title);
        player.loadVideoById(song.id);
        document.querySelector('#playBtn span').textContent = 'pause';
    }

    function nextTrack(){
        if(tracks.length===0) return;
        idx = (idx + 1) % tracks.length;
        playCurrent();
    }
    function prevTrack(){
        if(tracks.length===0) return;
        idx = idx<=0 ? tracks.length-1 : idx-1;
        playCurrent();
    }
    function togglePlay(){
        player.getPlayerState()===1 ? player.pauseVideo() : player.playVideo();
    }
    function toggleLoop(){
        loop = !loop;
        document.getElementById('loopBtn').classList.toggle('active',loop);
    }
    function updateProgress(){
        if(!player.getDuration) return;
        const p = (player.getCurrentTime()||0) / player.getDuration() * 100;
        document.getElementById('progress').style.width = p + '%';
    }
    function seek(e){
        const rect = e.currentTarget.getBoundingClientRect();
        const pos = (e.clientX - rect.left)/rect.width;
        player.seekTo(pos * player.getDuration());
    }

    function addToHistory(id,title){
        if(!history.some(h=>h.id===id)){
            history.unshift({id,title});
            if(history.length>100) history.pop();
            localStorage.setItem('hist',JSON.stringify(history));
            if(currentTab==='history') renderHistory();
        }
    }

    function renderFavorites(){
        const container = document.getElementById('favorites'); container.innerHTML='';
        currentSongs = favorites;
        favorites.forEach((s,i)=>{
            const div = document.createElement('div');
            div.className='card';
            div.innerHTML=`<img src="https://i.ytimg.com/vi/${s.id}/mqdefault.jpg">
                <div class="card-info"><div class="card-title">${s.title}</div></div>
                <div class="card-actions">
                    <button class="btn-play" onclick="playId('${s.id}','${s.title.replace(/'/g,"\\'")}')">播放</button>
                    <button class="btn-fav" onclick="favorites.splice(${i},1);localStorage.setItem('fav',JSON.stringify(favorites));renderFavorites();">刪除</button>
                </div>`;
            container.appendChild(div);
        });
    }

    function renderHistory(){
        const container = document.getElementById('history'); container.innerHTML='';
        currentSongs = history;
        history.forEach(s=>{
            const div = document.createElement('div');
            div.className='card';
            div.innerHTML=`<img src="https://i.ytimg.com/vi/${s.id}/mqdefault.jpg">
                <div class="card-info"><div class="card-title">${s.title}</div></div>
                <button class="btn-play" onclick="playId('${s.id}','${s.title.replace(/'/g,"\\'")}')">播放</button>`;
            container.appendChild(div);
        });
    }

    function switchTab(tab){
        currentTab = tab;
        document.querySelectorAll('#tabs button').forEach(b=>b.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.list, #page-controls').forEach(el=>el.classList.add('hidden'));
        document.getElementById(tab).classList.remove('hidden');
        if(tab!=='results') document.getElementById('page-controls').classList.remove('hidden');

        if(tab==='favorites') renderFavorites();
        if(tab==='history') renderHistory();
        if(tab==='results') document.getElementById('page-controls').classList.remove('hidden');
    }

    if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>