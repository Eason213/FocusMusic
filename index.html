<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Music</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:-apple-system,sans-serif;background:#000;color:#fff;min-height:100vh;}
        #search-bar{padding:15px;background:#000;position:sticky;top:0;z-index:10;display:flex;gap:10px;align-items:center;}
        #search{flex:1;padding:14px;background:#111;border:none;border-radius:12px;color:#fff;font-size:17px;}
        #search-btn{background:#ff0000;color:#fff;border:none;padding:14px 20px;border-radius:12px;font-size:20px;}
        #search-controls{margin:12px 0;display:flex;gap:10px;flex-wrap:wrap;padding:0 15px;}
        .btn{background:#ff0000;color:#fff;border:none;padding:11px 18px;border-radius:30px;font-size:15px;font-weight:600;}
        .btn-green{background:#00aa00;}
        #tabs{display:flex;background:#111;position:sticky;top:68px;z-index:9;}
        #tabs button{flex:1;padding:16px;background:none;border:none;color:#888;font-size:15px;}
        #tabs button.active{color:#ff0000;border-bottom:3px solid #ff0000;}
        ul{list-style:none;padding:0 12px;}
        li{display:flex;align-items:center;padding:14px 0;border-bottom:1px solid #222;}
        li img{width:56px;height:56px;border-radius:8px;margin-right:14px;object-fit:cover;}
        .info{flex:1;}
        .title{font-size:16px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .artist{font-size:13px;color:#aaa;margin-top:3px;}
        .actions button{background:#333;padding:6px 12px;border-radius:20px;font-size:13px;margin-left:6px;}

        #player{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,0.95));padding:20px;backdrop-filter:blur(20px);border-top:1px solid #222;}
        #current-title{font-size:18px;font-weight:600;margin-bottom:8px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        #progress-container{width:100%;height:4px;background:#333;border-radius:2px;margin:10px 0;position:relative;cursor:pointer;}
        #progress{width:0%;height:100%;background:#ff0000;border-radius:2px;}
        #controls{display:flex;justify-content:center;align-items:center;gap:35px;margin-top:10px;}
        #controls button{background:none;border:none;color:#fff;width:60px;height:60px;display:flex;align-items:center;justify-content:center;}
        #prevBtn,#nextBtn,#loopBtn{font-size:46px;}
        #playBtn{font-size:56px;}
        .active-loop{color:#ff0000 !important;}

        #mode-info{padding:0 15px;font-size:14px;color:#00ff00;height:20px;text-align:center;}
        #youtube-player{position:fixed;top:-100vh;left:-100vw;width:1px;height:1px;opacity:0;}
        .hidden{display:none !important;}
    </style>
</head>
<body>

<div id="search-bar">
    <input type="text" id="search" placeholder="搜尋歌曲…" onkeypress="if(event.key==='Enter') search()">
    <button id="search-btn" onclick="search()">Search</button>
</div>

<div id="search-controls" class="hidden">
    <button class="btn btn-green" onclick="playAllSearch()">全部自動播放</button>
    <button class="btn" onclick="addAllToFav()">全部加入最愛</button>
</div>

<div id="tabs">
    <button class="active" onclick="tab('results')">搜尋</button>
    <button onclick="tab('favorites')">最愛</button>
    <button onclick="tab('history')">歷史</button>
</div>

<div id="mode-info"></div>

<ul id="results"></ul>
<div id="fav-controls" class="hidden" style="padding:15px;text-align:center;">
    <button class="btn btn-green" onclick="playFav('normal')">全部播放</button>
    <button class="btn" onclick="playFav('shuffle')">隨機播放</button>
</div>
<ul id="favorites" class="hidden"></ul>
<ul id="history" class="hidden"></ul>

<div id="player">
    <div id="current-title">點擊歌曲開始播放</div>
    <div id="progress-container" onclick="seek(event)">
        <div id="progress"></div>
    </div>
    <div id="controls">
        <button id="loopBtn" onclick="toggleLoop()">
            <span class="material-icons">repeat</span>
        </button>
        <button id="prevBtn" onclick="prevTrack()">
            <span class="material-icons">skip_previous</span>
        </button>
        <button id="playBtn" onclick="togglePlay()">
            <span class="material-icons">play_arrow</span>
        </button>
        <button id="nextBtn" onclick="nextTrack()">
            <span class="material-icons">skip_next</span>
        </button>
    </div>
</div>

<div id="youtube-player"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    // ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←
    // 你只需要改這一行！！！只有這一行！！！
    const API_KEY = 'AIzaSyBpy0IZXf9kkkPh2FlO-UMTVXUSmNqqyTQ';  // ← 換成你的金鑰
    // ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←

    let player, tracks = [], idx = -1, mode = 'normal'; // normal, shuffle, loop
    let favorites = JSON.parse(localStorage.getItem('myfav')||'[]');
    let history   = JSON.parse(localStorage.getItem('myhist')||'[]');
    let blocked   = JSON.parse(localStorage.getItem('myblock')||'{}');
    let searchRes = [];

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('youtube-player', {
            playerVars: { playsinline:1, controls:0, rel:0 },
            events: { 'onReady':onReady, 'onStateChange':onStateChange }
        });
    }

    function onReady() {
        setInterval(updateProgress, 500);
    }

    async function search() {
        const q = document.getElementById('search').value.trim();
        if (!q || API_KEY==='YOUR_API_KEY') return alert('請輸入關鍵字並設定 API Key');
        const url = `https://www.googleapis.com/youtube/v3/search?key=${API_KEY}&q=${encodeURIComponent(q)}&part=snippet&type=video&maxResults=30&videoEmbeddable=true`;
        try {
            const r = await fetch(url);
            const d = await r.json();
            searchRes = d.items.filter(i => i.id?.videoId);
            const ul = document.getElementById('results'); ul.innerHTML = '';
            searchRes.forEach(item => {
                const id = item.id.videoId;
                const t = item.snippet;
                const li = document.createElement('li');
                li.innerHTML = `
                    <img src="${t.thumbnails.medium?.url || t.thumbnails.default.url}">
                    <div class="info">
                        <div class="title">${t.title}</div>
                        <div class="artist">${t.channelTitle}</div>
                    </div>
                    <div class="actions">
                        <button onclick="playId('${id}','${t.title.replace(/'/g,"\\'")}')">播放</button>
                        <button onclick="addFav('${id}','${t.title.replace(/'/g,"\\'")}')">Heart</button>
                    </div>`;
                ul.appendChild(li);
            });
            document.getElementById('search-controls').classList.remove('hidden');
        } catch(e) { alert('搜尋失敗：'+e); }
    }

    function playId(id,title){
        if(blocked[id]) return nextTrack();
        tracks = [{id,title}]; idx = 0;
        load(id,title);
    }
    function playAllSearch(){
        tracks = searchRes.map(i=>({id:i.id.videoId, title:i.snippet.title}));
        idx = 0; load(tracks[0].id, tracks[0].title);
    }
    function addAllToFav(){
        searchRes.forEach(i=>addFav(i.id.videoId, i.snippet.title));
    }
    function addFav(id,title){
        if(!favorites.some(f=>f.id===id)){
            favorites.push({id,title});
            localStorage.setItem('myfav', JSON.stringify(favorites));
            renderFav();
        }
    }

    function playFav(m){
        if(favorites.length===0) return;
        mode = m==='shuffle'?'shuffle':'normal';
        tracks = m==='shuffle'? [...favorites].sort(()=>Math.random()-0.5) : [...favorites];
        idx = 0; load(tracks[0].id, tracks[0].title);
    }

    function toggleLoop(){
        mode = mode==='loop'?'normal':'loop';
        document.getElementById('loopBtn').classList.toggle('active-loop', mode==='loop');
    }

    function load(id,title){
        document.getElementById('current-title').textContent = title;
        addHistory(id,title);
        player.loadVideoById(id);
        document.querySelector('#playBtn span').textContent = 'pause';
        document.getElementById('progress').style.width = '0%';
    }

    function onStateChange(e){
        const playIcon = document.querySelector('#playBtn span');
        if(e.data===1) playIcon.textContent='pause';
        if(e.data===2 || e.data===0) playIcon.textContent='play_arrow';
        if(e.data===0){
            if(mode==='loop' && tracks.length>0){
                idx = 0; load(tracks[0].id, tracks[0].title);
            } else nextTrack();
        }
        if(e.data===5) setTimeout(()=>checkBlock(),4000);
    }

    function checkBlock(){
        if(player.getPlayerState()!==1 && tracks[idx]){
            blocked[tracks[idx].id]=true;
            localStorage.setItem('myblock',JSON.stringify(blocked));
            nextTrack();
        }
    }

    function nextTrack(){
        if(tracks.length===0) return;
        if(mode==='shuffle') idx = Math.floor(Math.random()*tracks.length);
        else idx = (idx+1) % tracks.length;
        load(tracks[idx].id, tracks[idx].title);
    }
    function prevTrack(){
        if(idx<=0) idx = tracks.length;
        idx -= 2;
        nextTrack();
    }
    function togglePlay(){
        player.getPlayerState()===1 ? player.pauseVideo() : player.playVideo();
    }

    function updateProgress(){
        if(!player || !player.getDuration) return;
        const cur = player.getCurrentTime()||0;
        const dur = player.getDuration()||0;
        if(dur>0) document.getElementById('progress').style.width = (cur/dur*100)+'%';
    }
    function seek(e){
        const rect = e.target.getBoundingClientRect();
        const pos = (e.clientX - rect.left) / rect.width;
        player.seekTo(pos * player.getDuration());
    }

    function addHistory(id,title){
        if(!history.some(h=>h.id===id)){
            history.unshift({id,title});
            if(history.length>100) history.pop();
            localStorage.setItem('myhist', JSON.stringify(history));
            renderHistory();
        }
    }

    function renderFav(){
        const ul=document.getElementById('favorites'); ul.innerHTML='';
        favorites.forEach((f,i)=>{
            const li=document.createElement('li');
            li.innerHTML=`
                <img src="https://i.ytimg.com/vi/${f.id}/mqdefault.jpg">
                <div class="info"><div class="title">${f.title}</div></div>
                <div class="actions">
                    <button onclick="playId('${f.id}','${f.title.replace(/'/g,"\\'")}')">播放</button>
                    <button onclick="favorites.splice(${i},1);localStorage.setItem('myfav',JSON.stringify(favorites));renderFav();">刪除</button>
                </div>`;
            ul.appendChild(li);
        });
    }

    function renderHistory(){
        const ul=document.getElementById('history'); ul.innerHTML='';
        history.forEach(h=>{
            const li=document.createElement('li');
            li.innerHTML=`
                <img src="https://i.ytimg.com/vi/${h.id}/mqdefault.jpg">
                <div class="info"><div class="title">${h.title}</div></div>
                <button onclick="playId('${h.id}','${h.title.replace(/'/g,"\\'")}')">播放</button>`;
            ul.appendChild(li);
        });
    }

    function tab(t){
        document.querySelectorAll('#tabs button').forEach(b=>b.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('ul, #fav-controls').forEach(el=>el.classList.add('hidden'));
        document.getElementById(t).classList.remove('hidden');
        if(t==='favorites'){ renderFav(); document.getElementById('fav-controls').classList.remove('hidden'); }
        if(t==='history') renderHistory();
    }

    if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>