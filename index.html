<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MySpotify</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root{
            --spotify-green:#1ed760;
            --spotify-black:#121212;
            --spotify-dark:#181818;
            --spotify-gray:#282828;
        }
        *{margin:0;padding:0;box-sizing:border-box;}
        body,html{background:#000;color:#fff;font-family:'Circular Std','Segoe UI',system-ui,sans-serif;overflow:hidden;height:100vh;}
        #app{display:flex;height:100vh;position:relative;}

        /* ==== 左側欄 - 可收合 ==== */
        nav{
            width:240px;
            background:var(--spotify-black);
            padding:20px 0;
            position:fixed;
            left:0;top:0;bottom:0;
            overflow-y:auto;
            z-index:10;
            transition:left 0.4s cubic-bezier(0.4,0,0.2,1);
        }
        nav.hidden{left:-240px;}
        .logo{padding:0 24px;margin-bottom:30px;}
        .logo h1{color:#1ed760;font-size:32px;font-weight:900;}

        .nav-item{
            display:flex;align-items:center;
            padding:12px 24px;
            color:#b3b3b3;
            font-size:14px;
            font-weight:700;
            cursor:pointer;
            transition:0.2s;
        }
        .nav-item:hover,.nav-item.active{
            color:#fff;
            background:rgba(255,255,255,0.1);
        }
        .nav-item span.material-icons-round{
            font-size:24px;margin-right:16px;
        }

        /* 收合按鈕 */
        #toggle-sidebar{
            position:fixed;
            left:16px;
            top:16px;
            width:40px;height:40px;
            background:rgba(0,0,0,0.5);
            border-radius:50%;
            display:flex;align-items:center;justify-content:center;
            z-index:11;
            cursor:pointer;
            backdrop-filter:blur(10px);
            transition:0.3s;
        }
        nav:not(.hidden) ~ #toggle-sidebar{left:250px;}

        /* ==== 主內容 ==== */
        main{
            margin-left:240px;
            flex:1;
            overflow-y:auto;
            background:linear-gradient(to bottom,#1f1f1f,#121212);
            padding-bottom:100px;
            transition:margin-left 0.4s cubic-bezier(0.4,0,0.2,1);
        }
        nav.hidden ~ main{margin-left:72px;} /* 收合時留一點空間給 toggle 鈕 */

        .top-bar{
            height:70px;
            background:rgba(0,0,0,0.7);
            backdrop-filter:blur(20px);
            position:sticky;
            top:0;
            z-index:9;
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:0 32px;
        }
        .search-box{
            background:#282828;
            border-radius:50px;
            padding:10px 16px;
            display:flex;
            align-items:center;
            gap:12px;
            width:400px;
        }
        .search-box input{
            background:transparent;
            border:none;
            outline:none;
            color:#fff;
            width:100%;
            font-size:15px;
        }

        section{padding:24px 32px;}
        h1{font-size:48px;font-weight:900;margin-bottom:24px;}
        .grid{
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
            gap:24px;
        }
        .card{
            background:var(--spotify-gray);
            border-radius:8px;
            padding:16px;
            transition:0.2s;
            cursor:pointer;
            position:relative;
            overflow:hidden;
        }
        .card:hover{background:#333;transform:translateY(-4px);}
        .card img{width:100%;aspect-ratio:1;border-radius:8px;margin-bottom:12px;}
        .card h3{font-size:14px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .card p{font-size:13px;color:#b3b3b3;margin-top:4px;}
        .play-btn{
            position:absolute;
            bottom:80px;right:16px;
            background:var(--spotify-green);
            width:56px;height:56px;
            border-radius:50%;
            display:flex;align-items:center;justify-content:center;
            opacity:0;
            transform:translateY(10px) scale(0.8);
            transition:0.3s cubic-bezier(0.3,0,0,1);
            box-shadow:0 8px 20px rgba(30,215,96,0.4);
        }
        .card:hover .play-btn{
            opacity:1;
            transform:translateY(0) scale(1);
        }

        /* ==== 播放器 - 官方級按鈕排列 ==== */
        #player{
            position:fixed;
            bottom:0;left:0;right:0;
            height:90px;
            background:var(--spotify-black);
            border-top:1px solid #282828;
            display:flex;
            align-items:center;
            padding:0 16px;
            z-index:9999;
        }
        .player-left{
            display:flex;
            align-items:center;
            gap:16px;
            flex:1;
        }
        .player-left img{
            width:56px;height:56px;border-radius:4px;
        }
        .player-center{
            flex:2;
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:8px;
        }
        .player-controls{
            display:flex;
            align-items:center;
            gap:24px;
        }
        .player-controls button{
            background:none;
            border:none;
            color:#b3b3b3;
            cursor:pointer;
            transition:0.2s;
        }
        .player-controls button:hover{color:#fff;}
        .player-controls #playBtn{
            background:var(--spotify-green);
            color:#000;
            width:48px;height:48px;
            border-radius:50%;
            font-size:28px !important;
            display:flex;align-items:center;justify-content:center;
        }
        #loopBtn.active{color:var(--spotify-green);}
        .progress-bar{
            width:100%;
            height:4px;
            background:#404040;
            border-radius:2px;
            overflow:hidden;
            cursor:pointer;
        }
        .progress-fill{
            height:100%;
            width:0%;
            background:#fff;
            transition:width 0.1s;
        }
        .player-right{
            flex:1;
            display:flex;
            justify-content:flex-end;
            align-items:center;
            gap:16px;
            font-size:13px;
            color:#b3b3b3;
        }

        .hidden{display:none !important;}
    </style>
</head>
<body>
<div id="app">

    <!-- 收合按鈕 -->
    <div id="toggle-sidebar" onclick="toggleSidebar()">
        <span class="material-icons-round">menu</span>
    </div>

    <!-- 左側欄 -->
    <nav id="sidebar">
        <div class="logo"><h1>MySpotify</h1></div>
        <div class="nav-item active" onclick="showHome()"><span class="material-icons-round">home</span>首頁</div>
        <div class="nav-item" onclick="document.getElementById('search').focus()"><span class="material-icons-round">search</span>搜尋</div>
        <div class="nav-item" onclick="showLibrary()"><span class="material-icons-round">library_music</span>你的音樂庫</div>
        <div style="margin:30px 24px 10px;font-size:12px;color:#b3b3b3;">播放清單</div>
        <div id="folder-list-sidebar"></div>
        <div style="padding:0 24px;margin-top:auto;">
            <button onclick="createFolder()" style="width:100%;background:rgba(255,255,255,0.1);border:none;color:#fff;padding:12px;border-radius:4px;font-weight:700;">
                + 建立播放清單
            </button>
        </div>
    </nav>

    <!-- 主內容 -->
    <main>
        <div class="top-bar">
            <div></div>
            <div class="search-box">
                <span class="material-icons-round">search</span>
                <input type="text" id="search" placeholder="搜尋歌曲、藝人或播放清單">
            </div>
            <div></div>
        </div>

        <section id="home">
            <h1>全球熱門排行榜</h1>
            <div class="grid" id="top50"></div>
        </section>

        <section id="results" class="hidden">
            <h1>搜尋結果</h1>
            <div class="grid" id="search-results"></div>
        </section>

        <section id="folder-view" class="hidden"></section>
    </main>

    <!-- 播放器 -->
    <div id="player">
        <div class="player-left">
            <img id="now-thumb" src="" alt="">
            <div>
                <div id="current-title" style="font-weight:600;">準備播放</div>
                <div style="font-size:12px;color:#b3b3b3;">點擊開始聽歌</div>
            </div>
            <button><span class="material-icons-round">favorite_border</span></button>
        </div>

        <div class="player-center">
            <div class="player-controls">
                <button onclick="toggleLoop()" id="loopBtn"><span class="material-icons-round">repeat</span></button>
                <button onclick="prevTrack()"><span class="material-icons-round">skip_previous</span></button>
                <button id="playBtn" onclick="togglePlay()"><span class="material-icons-round">play_arrow</span></button>
                <button onclick="nextTrack()"><span class="material-icons-round">skip_next</span></button>
            </div>
            <div class="progress-bar" onclick="seek(event)">
                <div class="progress-fill" id="progress"></div>
            </div>
        </div>

        <div class="player-right">
            <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
        </div>
    </div>
</div>

<div id="youtube-player"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    const API_KEY = 'AIzaSyBpy0IZXf9kkkPh2FlO-UMTVXUSmNqqyTQ';
    let player, tracks = [], idx = -1, loop = false;
    let folders = JSON.parse(localStorage.getItem('myFolders')||'[]');

    // 收合側欄
    function toggleSidebar(){
        document.getElementById('sidebar').classList.toggle('hidden');
    }

    // YouTube Player
    function onYouTubeIframeAPIReady(){
        player = new YT.Player('youtube-player',{
            playerVars:{playsinline:1,controls:0,rel:0},
            events:{
                'onReady':()=>setInterval(updateProgress,500),
                'onStateChange':e=>{
                    document.querySelector('#playBtn span').textContent = e.data===1?'pause':'play_arrow';
                    if(e.data===0) loop?playCurrent():nextTrack();
                }
            }
        });
        loadTop50();
        renderFolders();
    }

    // 排行榜
    async function loadTop50(){
        const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&chart=mostPopular&videoCategoryId=10®ionCode=TW&maxResults=50&key=${API_KEY}`);
        const data = await res.json();
        const container = document.getElementById('top50');
        container.innerHTML='';
        data.items.forEach((v,i)=>{
            const div=document.createElement('div');
            div.className='card';
            div.innerHTML=`
                <img src="${v.snippet.thumbnails.medium.url}">
                <h3>${v.snippet.title}</h3>
                <p>${v.snippet.channelTitle}</p>
                <div class="play-btn" onclick="playSong('${v.id}','${v.snippet.title.replace(/'/g,"\\'")}','${v.snippet.thumbnails.medium.url}')">
                    <span class="material-icons-round">play_arrow</span>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // 播放核心（保持不變）
    function playSong(id,title,thumb){
        tracks=[{id,title,thumb}];
        idx=0;
        playCurrent();
    }
    function playCurrent(){
        const s=tracks[idx];
        document.getElementById('current-title').textContent=s.title;
        document.getElementById('now-thumb').src=s.thumb||'https://i.ytimg.com/vi/'+s.id+'/mqdefault.jpg';
        player.loadVideoById(s.id);
        document.querySelector('#playBtn span').textContent='pause';
    }
    function nextTrack(){idx=(idx+1)%tracks.length;playCurrent();}
    function prevTrack(){idx=idx<=0?tracks.length-1:idx-1;playCurrent();}
    function togglePlay(){player.getPlayerState()===1?player.pauseVideo():player.playVideo();}
    function toggleLoop(){loop=!loop;document.getElementById('loopBtn').classList.toggle('active',loop);}
    function updateProgress(){
        if(!player?.getDuration) return;
        const cur=player.getCurrentTime()||0, dur=player.getDuration()||0;
        document.getElementById('progress').style.width=(cur/dur*100)+'%';
        document.getElementById('current-time').textContent=formatTime(cur);
        document.getElementById('total-time').textContent=formatTime(dur);
    }
    function formatTime(t){const m=Math.floor(t/60),s=Math.floor(t%60);return `${m}:${s<10?'0'+s:s}`;}
    function seek(e){
        const rect=e.currentTarget.getBoundingClientRect();
        const pos=(e.clientX-rect.left)/rect.width;
        player.seekTo(pos*player.getDuration());
    }

    // 播放清單
    function createFolder(){
        const name=prompt('播放清單名稱');
        if(name){folders.push({name,songs:[]});saveAndRender();}
    }
    function renderFolders(){
        const list=document.getElementById('folder-list-sidebar');
        list.innerHTML=folders.map((f,i)=>`
            <div class="nav-item" onclick="openFolder(${i})">
                <span class="material-icons-round">queue_music</span>${f.name}
            </div>
        `).join('');
    }
    function openFolder(i){
        // 這裡可再擴充完整播放清單內頁
        alert('播放清單：'+folders[i].name+'（開發中，下一版上線）');
    }
    function saveAndRender(){
        localStorage.setItem('myFolders',JSON.stringify(folders));
        renderFolders();
    }

    function showHome(){location.reload();}
    function showLibrary(){/* 未來可切換到你的音樂庫 */}

    renderFolders();
    if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>