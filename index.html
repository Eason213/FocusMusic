<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FocusMusic</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<style>
:root{--g:#1ed760;--b:#121212;--g2:#282828;}
*{margin:0;padding:0;box-sizing:border-box;}
body,html{background:var(--b);color:#fff;font-family:system-ui;overflow:hidden;height:100vh;}

.top-bar{height:70px;background:rgba(0,0,0,0.92);backdrop-filter:blur(20px);position:fixed;top:0;left:0;right:0;z-index:999;
    display:flex;align-items:center;padding:0 16px;}
.top-bar h1{color:var(--g);font-size:32px;font-weight:900;margin-left:60px;}
#menuBtn{width:48px;height:48px;background:rgba(255,255,255,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;}

#sidebar{width:280px;background:var(--b);position:fixed;left:0;top:70px;bottom:0;overflow-y:auto;padding:20px 0;
    transition:transform .3s;transform:translateX(0);}
#sidebar.hidden{transform:translateX(-100%);}

main{margin-top:70px;padding:20px 16px 110px;overflow-y:auto;height:calc(100vh-70px);}

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(165px,1fr));gap:18px;}
.card{background:var(--g2);border-radius:12px;overflow:hidden;position:relative;cursor:pointer;transition:.25s;}
.card:hover{transform:scale(1.06);background:#333;}
.card img{width:100%;aspect-ratio:1;object-fit:cover;}
.card div{padding:12px;}
.card h3{font-size:15px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.playbtn{position:absolute;right:12px;bottom:68px;width:52px;height:52px;background:var(--g);color:#000;border-radius:50%;
    display:flex;align-items:center;justify-content:center;opacity:0;transition:.3s;box-shadow:0 8px 20px rgba(0,0,0,0.6);}
.card:hover .playbtn{opacity:1;}

#player{position:fixed;bottom:0;left:0;right:0;height:90px;background:var(--b);border-top:1px solid #333;
    display:flex;align-items:center;padding:0 16px;z-index:999;}
#player img{width:56px;height:56px;border-radius:8px;}
#current-title{font-weight:600;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.controls{display:flex;align-items:center;gap:30px;}
.controls button{background:none;border:none;color:#bbb;cursor:pointer;font-size:28px;}
#playBtn{background:var(--g);color:#000;width:48px;height:48px;border-radius:50%;font-size:32px!important;}
#loopBtn.active{color:var(--g);}
#loopBtn.single::after{content:"1";font-size:11px;background:#000;color:var(--g);border-radius:50%;width:16px;height:16px;
    position:absolute;margin-top:-24px;margin-left:4px;display:flex;align-items:center;justify-content:center;}
.progress{height:4px;background:#404040;border-radius:2px;overflow:hidden;width:100%;cursor:pointer;margin-top:8px;}
.progress div{height:100%;width:0%;background:#fff;transition:width .1s;}

#searchInput{width:100%;background:#fff;color:#000;padding:12px 20px;border-radius:30px;font-size:16px;outline:none;}

#modal{position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:9999;display:none;flex-direction:column;}
.modal-head{padding:20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #333;}
.modal-body{flex:1;overflow-y:auto;padding:0 20px;}
.song{padding:16px 0;display:flex;align-items:center;gap:16px;border-bottom:1px solid #333;cursor:pointer;}
.song img{width:50px;height:50px;border-radius:8px;}
.modal-foot{padding:20px;text-align:center;}
.modal-foot button{background:none;border:1px solid #666;color:#fff;padding:10px 20px;border-radius:30px;margin:0 8px;}
.modal-foot button:last-child{background:#e00;border:none;}
</style>
</head>
<body>

<div class="top-bar">
    <div id="menuBtn" onclick="document.getElementById('sidebar').classList.toggle('hidden')">
        <span class="material-icons-round">menu</span>
    </div>
    <h1>FocusMusic</h1>
</div>

<div id="sidebar">
    <div class="nav-item active" onclick="go('home')"><span class="material-icons-round">home</span> 首頁</div>
    <div class="nav-item" onclick="document.getElementById('searchInput').focus()"><span class="material-icons-round">search</span> 搜尋</div>
    <div class="nav-item" onclick="go('library')"><span class="material-icons-round">library_music</span> 你的音樂庫</div>
    <div style="margin:30px 0 10px 28px;color:#888;font-size:13px;">播放清單</div>
    <div id="plist"></div>
    <button onclick="newPl()" style="margin:20px 28px;padding:14px;background:rgba(255,255,255,0.1);border:none;border-radius:8px;color:#fff;width:calc(100%-56px);">+ 建立播放清單</button>
</div>

<main>
    <section id="home">
        <div style="display:flex;align-items:center;margin-bottom:16px;">
            <h1>為你推薦</h1>
            <span style="color:var(--g);margin-left:12px;cursor:pointer;" onclick="loadRec()">↻ 更新</span>
        </div>
        <input type="text" id="searchInput" placeholder="搜尋歌曲…" onkeypress="if(event.key==='Enter') searchNow()">
        <div class="grid" id="rec"></div>
        
        <h1 style="margin:50px 0 20px;">你的播放清單</h1>
        <div class="grid" id="mypl"></div>
    </section>

    <section id="results" class="hidden">
        <h1>搜尋結果</h1>
        <div class="grid" id="reslist"></div>
    </section>

    <section id="library" class="hidden">
        <h1>所有播放清單</h1>
        <div class="grid" id="liblist"></div>
    </section>
</main>

<div id="player">
    <div style="display:flex;align-items:center;gap:12px;flex:1;">
        <img id="now-thumb" src="">
        <div id="current-title">準備播放</div>
    </div>
    <div class="controls">
        <button id="loopBtn" onclick="loopMode=(loopMode+1)%3;updateLoopBtn()"><span class="material-icons-round">repeat</span></button>
        <button onclick="prev()"><span class="material-icons-round">skip_previous</span></button>
        <button id="playBtn" onclick="playPause()"><span class="material-icons-round">play_arrow</span></button>
        <button onclick="next()"><span class="material-icons-round">skip_next</span></button>
    </div>
    <div class="progress" onclick="seek(event)"><div id="bar"></div></div>
</div>

<!-- 播放清單彈窗 -->
<div id="modal">
    <div class="modal-head">
        <h2 id="plname"></h2>
        <span class="material-icons-round" onclick="document.getElementById('modal').style.display='none'" style="cursor:pointer;">close</span>
    </div>
    <div class="modal-body" id="songlist"></div>
    <div class="modal-foot">
        <button onclick="renamePl()">重新命名</button>
        <button onclick="deletePl()">刪除播放清單</button>
    </div>
</div>

<div id="yt" style="display:none;"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
const KEY = 'AIzaSyBpy0IZXf9kkkPh2FlO-UMTVXUSmNqqyTQ'; // ← 這裡換成你的
let player, list=[], pos=-1, loopMode=0, folders=JSON.parse(localStorage.getItem('fm3')||'[]'), curPl=-1;

// ---------- 播放核心 ----------
function onYouTubeIframeAPIReady(){
    player = new YT.Player('yt',{playerVars:{playsinline:1,controls:0},events:{
        'onReady':()=>setInterval(()=>document.getElementById('bar').style.width=(player.getCurrentTime()/player.getDuration()*100)+'%',500),
        'onStateChange':e=>{
            document.querySelector('#playBtn span').textContent = e.data===1?'pause':'play_arrow';
            if(e.data===0){
                if(loopMode===2) playNow();
                else if(loopMode===1 || pos<list.length-1) next();
            }
        }
    }});
    loadRec();
    draw();
}

function playThis(arr, start=0){
    list = arr;
    pos = start;
    playNow();
}
function playNow(){
    if(pos<0 || !list[pos]) return;
    const s = list[pos];
    document.getElementById('current-title').textContent = s.title;
    document.getElementById('now-thumb').src = s.thumb||'';
    player.loadVideoById(s.id);
}
function next(){ if(list.length>1) pos=(pos+1)%list.length; playNow(); }
function prev(){ if(list.length>1) pos=pos<=0?list.length-1:pos-1; playNow(); }
function playPause(){ player.getPlayerState()===1?player.pauseVideo():player.playVideo(); }
function updateLoopBtn(){
    const b=document.getElementById('loopBtn');
    b.className=''; b.innerHTML='<span class="material-icons-round">repeat</span>';
    if(loopMode===1) b.classList.add('active');
    if(loopMode===2) {b.classList.add('active','single'); b.innerHTML='<span class="material-icons-round">repeat_one</span>';}
}
function seek(e){
    const rect=e.currentTarget.getBoundingClientRect();
    player.seekTo((e.clientX-rect.left)/rect.width * player.getDuration());
}

// ---------- 推薦 ----------
async function loadRec(){
    const box=document.getElementById('rec'); box.innerHTML='載入中…';
    const r=await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&chart=mostPopular&videoCategoryId=10&regionCode=TW&maxResults=30&key=${KEY}`);
    const d=await r.json();
    box.innerHTML='';
    d.items.forEach(v=>{
        const s={id:v.id, title:v.snippet.title, thumb:v.snippet.thumbnails.medium.url};
        box.innerHTML+=`<div class="card" onclick="playThis([${JSON.stringify(s)}])">
            <img src="${s.thumb}"><div><h3>${s.title.substr(0,35)}…</h3></div>
            <div class="playbtn"><span class="material-icons-round">play_arrow</span></div>
        </div>`;
    });
}

// ---------- 搜尋 ----------
async function searchNow(){
    const q=document.getElementById('searchInput').value.trim();
    if(!q) return;
    go('results');
    const box=document.getElementById('reslist'); box.innerHTML='搜尋中…';
    const r=await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=30&q=${encodeURIComponent(q)}&videoEmbeddable=true&key=${KEY}`);
    const d=await r.json();
    box.innerHTML=''; const arr=[];
    d.items.forEach(it=>{
        if(!it.id?.videoId) return;
        const s={id:it.id.videoId, title:it.snippet.title, thumb:it.snippet.thumbnails.medium?.url};
        arr.push(s);
        box.innerHTML+=`<div class="card" onclick="playThis(arr, ${arr.length-1})">
            <img src="${s.thumb}"><div><h3>${s.title}</h3></div>
            <div class="playbtn"><span class="material-icons-round">play_arrow</span></div>
        </div>`;
    });
}

// ---------- 播放清單 ----------
function newPl(){
    const n=prompt('播放清單名稱'); if(n){folders.push({name:n,songs:[]});save();}
}
function openPl(i){
    curPl=i;
    document.getElementById('plname').textContent=folders[i].name;
    const box=document.getElementById('songlist'); box.innerHTML='';
    folders[i].songs.forEach((s,j)=>{
        box.innerHTML+=`<div class="song" onclick="playThis(folders[${i}].songs, ${j})">
            <img src="${s.thumb}"><div style="flex:1;"><div style="font-weight:600;">${s.title}</div></div>
            <span class="material-icons-round" onclick="event.stopPropagation();delSong(${i},${j})" style="color:#f66;">delete</span>
        </div>`;
    });
    document.getElementById('modal').style.display='flex';
}
function delSong(pi,si){folders[pi].songs.splice(si,1);save();openPl(pi);}
function renamePl(){const n=prompt('新名稱',folders[curPl].name);if(n){folders[curPl].name=n;save();}}
function deletePl(){if(confirm('確定刪除？')){folders.splice(curPl,1);save();document.getElementById('modal').style.display='none';}}
function save(){localStorage.setItem('fm3',JSON.stringify(folders));draw();}
function draw(){
    ['plist','mypl','liblist'].forEach(id=>{
        const e=document.getElementById(id);
        if(!e) return;
        e.innerHTML=folders.map((f,i)=>`
            <div class="nav-item" onclick="openPl(${i})">
                <span class="material-icons-round">queue_music</span> ${f.name} <small>(${f.songs.length})</small>
            </div>`).join('');
    });
    document.getElementById('mypl').innerHTML=folders.map((f,i)=>`
        <div class="card" onclick="openPl(${i})">
            <img src="${f.songs[0]?.thumb||''}"><div><h3>${f.name}</h3><p>${f.songs.length}首</p></div>
        </div>`).join('');
}

function go(sec){
    document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
    document.getElementById(sec).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.querySelector(`[onclick="go('${sec}')"]`)?.classList.add('active');
}

// 啟動
draw();
</script>
</body>
</html>