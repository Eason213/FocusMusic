<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FocusMusic</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root{--green:#1ed760;--black:#121212;--dark:#181818;--gray:#282828;}
        *{margin:0;padding:0;box-sizing:border-box;}
        body,html{background:var(--black);color:#fff;font-family:system-ui,sans-serif;overflow:hidden;height:100vh;}
        #app{display:flex;height:100vh;position:relative;}

        nav{width:260px;background:var(--black);padding:20px 0;position:fixed;left:0;top:0;bottom:0;overflow-y:auto;z-index:10;transition:left .4s ease;}
        nav.hidden{left:-260px;}
        .logo{padding:0 28px;margin-bottom:40px;}
        .logo h1{color:var(--green);font-size:36px;font-weight:900;}
        .nav-item{display:flex;align-items:center;padding:14px 28px;color:#b3b3b3;font-size:15px;font-weight:700;cursor:pointer;transition:.2s;}
        .nav-item:hover,.nav-item.active{color:#fff;background:rgba(255,255,255,.1);}
        .nav-item span.material-icons-round{font-size:26px;margin-right:18px;}

        #toggle-sidebar{position:fixed;left:20px;top:20px;width:44px;height:44px;background:rgba(0,0,0,.6);border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:11;cursor:pointer;backdrop-filter:blur(12px);transition:left .4s;}
        nav:not(.hidden)~#toggle-sidebar{left:270px;}

        main{margin-left:260px;flex:1;overflow-y:auto;background:linear-gradient(#1a1a1a,#121212);padding-bottom:100px;transition:margin-left .4s;}
        nav.hidden~郊main{margin-left:80px;}

        .top-bar{height:70px;background:rgba(0,0,0,.7);backdrop-filter:blur(20px);position:sticky;top:0;z-index:9;display:flex;align-items:center;justify-content:space-between;padding:0 32px;}
        .search-box{background:#fff;color:#000;border-radius:50px;padding:12px 20px;display:flex;align-items:center;gap:14px;width:420px;box-shadow:0 4px 15px rgba(0,0,0,.3);}
        .search-box input{background:transparent;border:none;outline:none;font-size:16px;width:100%;}

        section{padding:30px 40px;}
        h1{font-size:52px;font-weight:900;margin-bottom:30px;}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:26px;}
        .card{background:var(--gray);border-radius:10px;padding:18px;transition:.3s;cursor:pointer;position:relative;overflow:hidden;}
        .card:hover{background:#333;transform:translateY(-6px);}
        .card img{width:100%;aspect-ratio:1;border-radius:8px;margin-bottom:14px;}
        .card h3{font-size:15px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .card p{font-size:13px;color:#b3b3b3;margin-top:4px;}
        .play-btn,.add-btn{position:absolute;bottom:84px;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0;transform:scale(.8);transition:.3s ease;box-shadow:0 10px 30px rgba(0,0,0,.5);}
        .play-btn{right:88px;background:var(--green);color:#000;}
        .add-btn{right:18px;background:rgba(255,255,255,.15);color:#fff;}
        .card:hover .play-btn,.card:hover .add-btn{opacity:1;transform:scale(1);}

        #player{position:fixed;bottom:0;left:0;right:0;height:94px;background:var(--black);border-top:1px solid #282828;display:flex;align-items:center;padding:0 24px;z-index:9999;}
        .player-left{display:flex;align-items:center;gap:16px;flex:1;}
        .player-left img{width:60px;height:60px;border-radius:6px;}
        .player-center{flex:2;display:flex;flex-direction:column;align-items:center;gap:10px;}
        .player-controls{display:flex;align-items:center;gap:32px;}
        .player-controls button{background:none;border:none;color:#b3b3b3;cursor:pointer;transition:.2s;font-size:26px;}
        .player-controls button:hover{color:#fff;}
        #0
        #playBtn{background:var(--green)!important;color:#000!important;width:52px;height:52px;border-radius:50%;font-size:30px!important;}
        .progress-bar{width:100%;height:5px;background:#404040;border-radius:3px;overflow:hidden;cursor:pointer;}
        .progress-fill{height:100%;width:0%;background:#fff;transition:width .1s;}
        .player-right{flex:1;display:flex;justify-content:flex-end;align-items:center;gap:16px;color:#b3b3b3;font-size:14px;}

        .hidden{display:none!important;}
    </style>
</head>
<body>
<div id="app">
    <div id="toggle-sidebar" onclick="toggleSidebar()">
        <span class="material-icons-round">menu</span>
    </div>

    <nav id="sidebar">
        <div class="logo"><h1>FocusMusic</h1></div>
        <div class="nav-item active" onclick="showSection('home')"><span class="material-icons-round">home</span>首頁</div>
        <div class="nav-item" onclick="document.getElementById('search').focus()"><span class="material-icons-round">search</span>搜尋</div>
        <div class="nav-item" onclick="showSection('library')"><span class="material-icons-round">library_music</span>你的音樂庫</div>
        <div style="margin:40px 28px 10px;font-size:13px;color:#888;">播放清單</div>
        <div id="folder-list-sidebar"></div>
        <div style="padding:0 28px;margin-top:auto;">
            <button onclick="createFolder()" style="width:100%;background:rgba(255,255,255,.1);border:none;color:#fff;padding:14px;border-radius:8px;font-weight:700;">
                + 建立播放清單
            </button>
        </div>
    </nav>

    <main>
        <div class="top-bar">
            <div></div>
            <div class="search-box">
                <span class="material-icons-round">search</span>
                <input type="text" id="search" placeholder="搜尋歌曲、藝人、播放清單…" onkeypress="if(event.key==='Enter') search()">
            </div>
            <div></div>
        </div>

        <section id="home">
            <h1>為你推薦</h1>
            <div class="grid" id="top50"></div>
            <h1 style="margin-top:60px;">你的播放清單</h1>
            <div class="grid" id="user-playlists"></div>
        </section>

        <section id="results" class="hidden">
            <h1>搜尋結果</h1>
            <div class="grid" id="search-results"></div>
        </section>

        <section id="library" class="hidden">
            <h1>你的音樂庫</h1>
            <div class="grid" id="user-playlists-lib"></div>
        </section>
    </main>

    <div id="player">
        <div class="player-left">
            <img id="now-thumb" src="" alt="">
            <div>
                <div id="current-title" style="font-weight:600;">準備播放</div>
                <div style="font-size:13px;color:#b3b3b3;">FocusMusic</div>
            </div>
        </div>
        <div class="player-center">
            <div class="player-controls">
                <button onclick="toggleLoop()" id="loopBtn"><span class="material-icons-round">repeat</span></button>
                <button onclick="prevTrack()"><span class="material-icons-round">skip_previous</span></button>
                <button id="playBtn" onclick="togglePlay()"><span class="material-icons-round">play_arrow</span></button>
                <button onclick="nextTrack()"><span class="material-icons-round">skip_next</span></button>
            </div>
            <div class="progress-bar" onclick="seek(event)">
                <div class="progress-fill" id="progress"></div>
            </div>
        </div>
        <div class="player-right">
            <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
        </div>
    </div>
</div>

<div id="youtube-player"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    const API_KEY = 'AIzaSyBpy0IZXf9kkkPh2FlO-UMTVXUSmNqqyTQ';
    let player, tracks = [], idx = -1, loop = false;
    let folders = JSON.parse(localStorage.getItem('focusFolders')||'[]');

    function toggleSidebar(){document.getElementById('sidebar').classList.toggle('hidden');}
    function showSection(s){
        document.querySelectorAll('section').forEach(el=>el.classList.add('hidden'));
        document.getElementById(s).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
        document.querySelector(`[onclick="showSection('${s}')"]`)?.classList.add('active');
        if(s==='home') {loadTop50(); renderUserPlaylists();}
    }

    async function search(){
        const q = document.getElementById('search').value.trim();
        if(!q) return;
        showSection('results');
        const container = document.getElementById('search-results');
        container.innerHTML = '<div style="text-align:center;padding:80px;color:#666;font-size:18px;">搜尋中…</div>';
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=30&q=${encodeURIComponent(q)}&videoEmbeddable=true&key=${API_KEY}`);
        const data = await res.json();
        container.innerHTML = '';
        data.items.forEach(item=>{
            if(item.id?.videoId){
                const song = {id:item.id.videoId,title:item.snippet.title,thumb:item.snippet.thumbnails.medium?.url};
                const div = document.createElement('div');
                div.className='card';
                div.innerHTML = `
                    <img src="${song.thumb}">
                    <h3>${song.title}</h3>
                    <p>${item.snippet.channelTitle}</p>
                    <div class="play-btn" onclick="playSong('${song.id}','${song.title.replace(/'/g,"\\'")}','${song.thumb}')">
                        <span class="material-icons-round">play_arrow</span>
                    </div>
                    <div class="add-btn" onclick="addToPlaylistPrompt('${song.id}','${song.title.replace(/'/g,"\\'")}','${song.thumb}')">
                        <span class="material-icons-round">add</span>
                    </div>
                `;
                container.appendChild(div);
            }
        });
    }

    async function loadTop50(){
        const container = document.getElementById('top50');
        container.innerHTML = '<div style="text-align:center;padding:60px;color:#666;">載入中…</div>';
        const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&chart=mostPopular&videoCategoryId=10®ionCode=TW&maxResults=20&key=${API_KEY}`);
        const data = await res.json();
        container.innerHTML = '';
        data.items.forEach(v=>{
            const div=document.createElement('div');
            div.className='card';
            div.innerHTML=`
                <img src="${v.snippet.thumbnails.medium.url}">
                <h3>${v.snippet.title.substr(0,40)}${v.snippet.title.length>40?'…':''}</h3>
                <p>${v.snippet.channelTitle}</p>
                <div class="play-btn" onclick="playSong('${v.id}','${v.snippet.title.replace(/'/g,"\\'")}','${v.snippet.thumbnails.medium.url}')">
                    <span class="material-icons-round">play_arrow</span>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function playSong(id,title,thumb){tracks=[{id,title,thumb}];idx=0;playCurrent();}
    function playCurrent(){
        const s=tracks[idx];
        document.getElementById('current-title').textContent=s.title;
        document.getElementById('now-thumb').src=s.thumb;
        player.loadVideoById(s.id);
    }
    function nextTrack(){idx=(idx+1)%tracks.length;playCurrent();}
    function prevTrack(){idx=idx<=0?tracks.length-1:idx-1;playCurrent();}
    function togglePlay(){player.getPlayerState()===1?player.pauseVideo():player.playVideo();}
    function toggleLoop(){loop=!loop;document.getElementById('loopBtn').classList.toggle('active',loop);}

    function onYouTubeIframeAPIReady(){
        player = new YT.Player('youtube-player',{playerVars:{playsinline:1,controls:0,rel:0},events:{
            'onReady':()=>setInterval(updateProgress,500),
            'onStateChange':e=>{
                document.querySelector('#playBtn span').textContent=e.data===1?'pause':'play_arrow';
                if(e.data===0) loop?playCurrent():nextTrack();
            }
        }});
        loadTop50();
        renderAll();
    }

    function addToPlaylistPrompt(id,title,thumb){
        if(folders.length===0){alert('請先建立一個播放清單');createFolder();return;}
        const names = folders.map(f=>f.name).join(' / ');
        const choice = prompt(`加入哪個播放清單？\n${names}\n\n或輸入新名稱建立`, folders[0].name);
        if(!choice) return;
        let target = folders.find(f=>f.name===choice);
        if(!target){target={name:choice,songs:[]};folders.push(target);}
        target.songs.push({id,title,thumb});
        localStorage.setItem('focusFolders',JSON.stringify(folders));
        renderAll();
    }

    function createFolder(){
        const name=prompt('播放清單名稱');
        if(name){folders.push({name,songs:[]});localStorage.setItem('focusFolders',JSON.stringify(folders));renderAll();}
    }

    function renderAll(){
        renderFolders();
        renderUserPlaylists();
    }
    function renderFolders(){
        const list=document.getElementById('folder-list-sidebar');
        list.innerHTML=folders.map(f=>`
            <div class="nav-item" onclick="alert('即將開啟播放清單：${f.name}')">
                <span class="material-icons-round">queue_music</span>${f.name} <small>(${f.songs.length})</small>
            </div>
        `).join('');
    }
    function renderUserPlaylists(){
        const container=document.getElementById('user-playlists');
        container.innerHTML='';
        folders.forEach(f=>{
            const div=document.createElement('div');
            div.className='card';
            div.innerHTML=`
                <img src="${f.songs[0]?.thumb||'https://i.imgur.com/8z6Q7vJ.png'}">
                <h3>${f.name}</h3>
                <p>${f.songs.length} 首歌曲</p>
                <div class="play-btn" onclick="playPlaylist('${f.name}')">
                    <span class="material-icons-round">play_arrow</span>
                </div>
            `;
            container.appendChild(div);
        });
    }
    function playPlaylist(name){
        const pl = folders.find(f=>f.name===name);
        if(pl && pl.songs.length>0){
            tracks = pl.songs;
            idx = 0;
            playCurrent();
        }
    }

    function updateProgress(){
        if(!player?.getDuration) return;
        const cur=player.getCurrentTime()||0, dur=player.getDuration()||0;
        document.getElementById('progress').style.width=(cur/dur*100)+'%';
        document.getElementById('current-time').textContent=formatTime(cur);
        document.getElementById('total-time').textContent=formatTime(dur);
    }
    function formatTime(t){const m=Math.floor(t/60),s=Math.floor(t%60);return `${m}:${s<10?'0'+s:s}`;}
    function seek(e){
        const rect=e.currentTarget.getBoundingClientRect();
        const pos=(e.clientX-rect.left)/rect.width;
        player.seekTo(pos*player.getDuration());
    }

    renderAll();
    if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>