<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Music</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* 上面所有樣式不變，省略… */
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:-apple-system,sans-serif;background:#000;color:#fff;min-height:100vh;}
        #search-bar{padding:15px;background:#000;position:sticky;top:0;z-index:10;display:flex;gap:10px;align-items:center;}
        #search{flex:1;padding:14px;background:#111;border:none;border-radius:12px;color:#fff;font-size:17px;}
        #search-btn{background:#ff0000;color:#fff;border:none;padding:14px 18px;border-radius:12px;font-size:20px;}
        /* 其他樣式和之前完全一樣，省略不重複 */
        #search-controls{margin:12px 0;display:flex;gap:10px;flex-wrap:wrap;padding:0 15px;}
        .btn{background:#ff0000;color:#fff;border:none;padding:11px 18px;border-radius:30px;font-size:15px;font-weight:600;}
        .btn-green{background:#00aa00;}
        #tabs{display:flex;background:#111;position:sticky;top:68px;z-index:9;}
        #tabs button{flex:1;padding:16px;background:none;border:none;color:#888;font-size:15px;}
        #tabs button.active{color:#ff0000;border-bottom:3px solid #ff0000;}
        ul{list-style:none;padding:0 12px;}
        li{display:flex;align-items:center;padding:14px 0;border-bottom:1px solid #222;}
        li img{width:56px;height:56px;border-radius:8px;margin-right:14px;object-fit:cover;}
        .info{flex:1;}
        .title{font-size:16px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .artist{font-size:13px;color:#aaa;margin-top:3px;}
        .actions button{background:#333;padding:6px 12px;border-radius:20px;font-size:13px;margin-left:6px;}
        #player{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,0.95));padding:20px 20px 35px;backdrop-filter:blur(20px);border-top:1px solid #222;text-align:center;}
        #current-title{font-size:18px;font-weight:600;margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:90vw;}
        #controls{display:flex;justify-content:center;align-items:center;gap:40px;margin-top:15px;}
        #controls button{background:none;border:none;color:#fff;font-size:42px;width:60px;height:60px;display:flex;align-items:center;justify-content:center;}
        #prevBtn{font-size:48px;}
        #playBtn{font-size:56px;}
        #nextBtn{font-size:48px;}
        #mode-info{padding:0 15px;font-size:14px;color:#00ff00;height:20px;}
        #youtube-player{position:fixed;top:-100vh;left:-100vw;width:1px;height:1px;opacity:0;}
        .hidden{display:none !important;}
    </style>
</head>
<body>

<div id="search-bar">
    <input type="text" id="search" placeholder="搜尋歌曲…" onkeypress="if(event.key==='Enter') search()">
    <button id="search-btn" onclick="search()">Search</button>
</div>

<div id="search-controls" class="hidden">
    <button class="btn btn-green" onclick="playAllSearch()">全部自動播放</button>
    <button class="btn" onclick="addAllToFav()">全部加入最愛</button>
</div>

<div id="tabs">
    <button class="active" onclick="tab('results')">搜尋</button>
    <button onclick="tab('favorites')">最愛</button>
    <button onclick="tab('history')">歷史</button>
</div>

<div id="mode-info"></div>

<ul id="results"></ul>
<div id="fav-controls" class="hidden" style="padding:15px;text-align:center;">
    <button class="btn btn-green" onclick="playFav('normal')">全部播放</button>
    <button class="btn" onclick="playFav('shuffle')">隨機播放</button>
    <button class="btn" onclick="toggleLoop()">循環</button>
    <button class="btn" onclick="toggleSingle()">單曲</button>
</div>
<ul id="favorites" class="hidden"></ul>
<ul id="history" class="hidden"></ul>

<div id="player">
    <div id="current-title">點擊歌曲開始播放</div>
    <div id="controls">
        <button id="prevBtn" onclick="prevTrack()">
            <span class="material-icons">skip_previous</span>
        </button>
        <button id="playBtn" onclick="togglePlay()">
            <span class="material-icons">play_arrow</span>
        </button>
        <button id="nextBtn" onclick="nextTrack()">
            <span class="material-icons">skip_next</span>
        </button>
    </div>
</div>

<div id="youtube-player"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    // ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←
    // 你只需要改這一行的 API Key！！！就這一處！！！
    const API_KEY = 'AIzaSyBpy0IZXf9kkkPh2FlO-UMTVXUSmNqqyTQ';   // ←←← 改成你的 AIzaSyB... 這裡
    // ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←

    let player, tracks = [], idx = -1, mode = 'normal';
    let favorites = JSON.parse(localStorage.getItem('f')) || [];
    let history   = JSON.parse(localStorage.getItem('h')) || [];
    let blocked   = JSON.parse(localStorage.getItem('b')) || {};
    let searchRes = [];

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('youtube-player', {
            playerVars: { playsinline:1, controls:0, rel:0, mute:0 },
            events: { 'onReady':()=>{}, 'onStateChange':onStateChange }
        });
    }

    // 現在打字完直接按 Enter 或點右邊紅色放大鏡就會搜尋了！
    async function search() {
        const q = document.getElementById('search').value.trim();
        if (!q) return;
        if (API_KEY === 'YOUR_API_KEY') { alert('請先把 API_KEY 換成你的金鑰！'); return; }

        const url = `https://www.googleapis.com/youtube/v3/search?key=${API_KEY}&q=${encodeURIComponent(q)}&part=snippet&type=video&maxResults=30`;
        try {
            const r = await fetch(url);
            const d = await r.json();
            if (d.error) throw d.error.message;
            searchRes = d.items.filter(i=>i.id.videoId);
            const ul = document.getElementById('results');
            ul.innerHTML = '';
            searchRes.forEach(item=>{
                const id = item.id.videoId;
                const t = item.snippet;
                const li = document.createElement('li');
                li.innerHTML = `
                    <img src="${t.thumbnails.medium?.url || t.thumbnails.default.url}">
                    <div class="info">
                        <div class="title">${t.title}</div>
                        <div class="artist">${t.channelTitle}</div>
                    </div>
                    <div class="actions">
                        <button onclick="playId('${id}','${t.title.replace(/'/g,"\\'")}')">播放</button>
                        <button onclick="addFav('${id}','${t.title.replace(/'/g,"\\'")}')">Heart</button>
                    </div>`;
                ul.appendChild(li);
            });
            document.getElementById('search-controls').classList.remove('hidden');
        } catch(e) {
            alert('搜尋失敗：' + e);
        }
    }

    // 其他所有函式（播放、上一首、最愛…）和之前完全一樣，全部保留
    function togglePlay() {
        if (!player) return;
        const icon = document.querySelector('#playBtn span');
        if (player.getPlayerState() === 1) {
            player.pauseVideo();
            icon.textContent = 'play_arrow';
        } else {
            player.playVideo();
            icon.textContent = 'pause';
        }
    }
    function playId(id,title){
        if(blocked[id]) return nextTrack();
        tracks = [{id,title}]; idx = 0;
        load(id,title);
    }
    function playAllSearch(){
        tracks = searchRes.map(i=>({id:i.id.videoId, title:i.snippet.title}));
        idx = 0; load(tracks[0].id, tracks[0].title);
    }
    function addAllToFav(){
        searchRes.forEach(i=>{ addFav(i.id.videoId, i.snippet.title); });
    }
    function addFav(id,title){
        if(!favorites.some(f=>f.id===id)){ favorites.push({id,title}); localStorage.setItem('f',JSON.stringify(favorites)); renderFav(); }
    }
    function playFav(m){ /* 同前 */ }
    function toggleLoop(){ /* 同前 */ }
    function toggleSingle(){ /* 同前 */ }
    function updateMode(){ /* 同前 */ }
    function load(id,title){
        document.getElementById('current-title').textContent = title;
        addHistory(id,title);
        player.loadVideoById(id);
        document.querySelector('#playBtn span').textContent = 'pause';
    }
    function onStateChange(e){ /* 同前 */ }
    function nextTrack(){ /* 同前 */ }
    function prevTrack(){ /* 同前 */ }
    function addHistory(id,title){ /* 同前 */ }
    function renderFav(){ /* 同前 */ }
    function renderHistory(){ /* 同前 */ }
    function tab(t){ /* 同前 */ }

    // 以下函式保持不變（全部照抄前一版即可）
    // 為了節省篇幅這裡省略，但你直接把前一版的其餘程式碼貼進來即可
    // （playFav、toggleLoop、nextTrack… 全部保留）

    if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>