<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FocusMusic</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<style>
:root{--g:#1ed760;--b:#121212;--gray:#282828;}
*{margin:0;padding:0;box-sizing:border-box;}
body,html{background:var(--b);color:#fff;font-family:system-ui,sans-serif;overflow:hidden;height:100vh;display:flex;flex-direction:column;}

header{
    height:70px;background:rgba(0,0,0,0.95);backdrop-filter:blur(20px);
    padding:0 16px;display:flex;align-items:center;gap:16px;position:relative;z-index:10;
    box-shadow:0 4px 20px rgba(0,0,0,0.4);
}
header h1{color:var(--g);font-size:28px;font-weight:900;}
#search{width:100%;background:#fff;color:#000;padding:12px 20px;border-radius:30px;font-size:16px;outline:none;}

.filter{
    position:absolute;right:16px;top:50%;transform:translateY(-50%);
    background:#333;color:#fff;padding:8px 12px;border-radius:20px;font-size:14px;cursor:pointer;
}

main{flex:1;overflow-y:auto;padding:20px 16px 100px;background:linear-gradient(#181818,#121212);}
h1{font-size:36px;font-weight:900;margin:20px 0 16px;}

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:18px;}
.card{
    background:var(--gray);border-radius:12px;overflow:hidden;position:relative;cursor:pointer;
    transition:transform .25s,background .25s;
}
.card:hover{transform:scale(1.06);background:#333;}
.card img{width:100%;aspect-ratio:1;object-fit:cover;}
.card h3{padding:12px;font-size:15px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.play{position:absolute;right:12px;bottom:68px;width:52px;height:52px;background:var(--g);color:#000;
    border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0;transition:.3s;
    box-shadow:0 8px 20px rgba(0,0,0,0.6);}
.card:hover .play{opacity:1;}

#bigBtn{
    position:fixed;bottom:100px;left:50%;transform:translateX(-50%);
    background:var(--g);color:#000;padding:16px 40px;border-radius:50px;
    font-size:18px;font-weight:900;cursor:pointer;z-index:99;
    box-shadow:0 10px 30px rgba(30,215,96,0.5);
}

#player{
    position:fixed;bottom:0;left:0;right:0;height:90px;background:var(--b);
    border-top:1px solid #333;display:flex;align-items:center;padding:0 16px;z-index:999;
}
#player img{width:56px;height:56px;border-radius:8px;}
#title{font-weight:600;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.controls{display:flex;align-items:center;gap:28px;}
.controls button{background:none;border:none;color:#bbb;cursor:pointer;font-size:28px;}
#playBtn{background:var(--g);color:#000;width:48px;height:48px;border-radius:50%;font-size:32px!important;}
#loopBtn.active{color:var(--g);}
#loopBtn.single::after{content:"1";font-size:11px;background:#000;color:var(--g);border-radius:50%;padding:2px;position:absolute;margin-left:4px;}
.progress{height:4px;background:#404040;border-radius:2px;overflow:hidden;width:100%;cursor:pointer;margin-top:8px;}
.progress div{height:100%;width:0%;background:#fff;transition:width .1s;}

#plModal{position:fixed;inset:0;background:rgba(0,0,0,0.97);z-index:9999;display:none;flex-direction:column;padding:20px;}
#plModal h2{font-size:28px;margin-bottom:20px;}
#plList{flex:1;overflow-y:auto;}
.plItem{padding:16px;border-bottom:1px solid #333;cursor:pointer;}
</style>
</head>
<body>

<header>
    <h1>FocusMusic</h1>
    <input type="text" id="search" placeholder="搜尋歌曲或播放清單…" onkeypress="if(event.key==='Enter') doSearch()">
    <div class="filter" onclick="toggleFilter()">歌曲 ∨</div>
</header>

<main id="main">
    <h1 id="pageTitle">為你推薦</h1>
    <div class="grid" id="list"></div>
</main>

<div id="bigBtn" onclick="shuffleAll()">隨機播放全部</div>

<div id="player">
    <div style="display:flex;align-items:center;gap:12px;flex:1;">
        <img id="thumb" src="">
        <div id="title">準備播放</div>
    </div>
    <div class="controls">
        <button id="loopBtn" onclick="loop=(loop+1)%3;updateLoop()"><span class="material-icons-round">repeat</span></button>
        <button onclick="prev()"><span class="material-icons-round">skip_previous</span></button>
        <button id="playBtn" onclick="playPause()"><span class="material-icons-round">play_arrow</span></button>
        <button onclick="next()"><span class="material-icons-round">skip_next</span></button>
    </div>
    <div class="progress" onclick="seek(event)"><div id="bar"></div></div>
</div>

<!-- 播放清單彈窗 -->
<div id="plModal">
    <h2>你的播放清單</h2>
    <div id="plList"></div>
    <button onclick="newPlaylist()" style="margin-top:20px;background:var(--g);color:#000;padding:14px;border-radius:50px;width:100%;font-weight:700;border:none;">+ 建立播放清單</button>
    <button onclick="document.getElementById('plModal').style.display='none'" style="margin-top:10px;background:#333;color:#fff;padding:14px;border-radius:50px;width:100%;border:none;">關閉</button>
</div>

<div id="yt" style="display:none;"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
const KEY = 'AIzaSyBpy0IZXf9kkkPh2FlO-UMTVXUSmNqqyTQ';
let player, queue=[], idx=-1, loop=0, playlists=JSON.parse(localStorage.getItem('fm_playlists')||'[]');
let currentMode = 'songs'; // songs 或 playlists

function onYouTubeIframeAPIReady(){
    player = new YT.Player('yt',{
        playerVars:{playsinline:1,controls:0},
        events:{
            'onReady':()=>setInterval(()=>document.getElementById('bar').style.width=(player.getCurrentTime()/player.getDuration()*100)+'%',500),
            'onStateChange':e=>{
                document.querySelector('#playBtn span').textContent=e.data===1?'pause':'play_arrow';
                if(e.data===0){
                    if(loop===2) playNow();
                    else if(loop===1 || idx<queue.length-1) next();
                }
            }
        }
    });
    loadRecommend();
}

function playThis(arr, start=0){
    queue = arr;
    idx = start;
    playNow();
}
function playNow(){
    if(idx<0 || !queue[idx]) return;
    const s = queue[idx];
    document.getElementById('title').textContent = s.title;
    document.getElementById('thumb').src = s.thumb || '';
    player.loadVideoById(s.id);
}
function next(){ if(queue.length>1) idx=(idx+1)%queue.length; playNow(); }
function prev(){ if(queue.length>1) idx=idx<=0?queue.length-1:idx-1; playNow(); }
function playPause(){ player.getPlayerState()===1?player.pauseVideo():player.playVideo(); }
function updateLoop(){
    const b=document.getElementById('loopBtn');
    b.className=''; b.innerHTML='<span class="material-icons-round">repeat</span>';
    if(loop===1) b.classList.add('active');
    if(loop===2){ b.classList.add('active','single'); b.innerHTML='<span class="material-icons-round">repeat_one</span>'; }
}
function seek(e){
    const r=e.currentTarget.getBoundingClientRect();
    player.seekTo((e.clientX-r.left)/r.width * player.getDuration());
}
function shuffleAll(){
    if(queue.length<2) return alert('歌曲太少啦～多搜點歌再隨機吧！');
    const shuffled = [...queue].sort(()=>Math.random()-0.5);
    playThis(shuffled,0);
}

async function loadRecommend(){
    document.getElementById('pageTitle').textContent = '為你推薦';
    const box=document.getElementById('list');
    box.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:60px;color:#666;">載入中…</div>';
    const r=await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&chart=mostPopular&videoCategoryId=10&regionCode=TW&maxResults=50&key=${KEY}`);
    const d=await r.json();
    box.innerHTML='';
    d.items.forEach(v=>{
        const s={id:v.id,title:v.snippet.title,thumb:v.snippet.thumbnails.medium.url};
        box.innerHTML+=`<div class="card" onclick="playThis([${JSON.stringify(s)}])">
            <img src="${s.thumb}"><h3>${s.title.slice(0,40)}…</h3>
            <div class="play"><span class="material-icons-round">play_arrow</span></div>
        </div>`;
    });
}

async function doSearch(){
    const q=document.getElementById('search').value.trim();
    if(!q) return;
    document.getElementById('pageTitle').textContent='搜尋結果';
    const box=document.getElementById('list'); box.innerHTML='搜尋中…';
    const r=await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=50&q=${encodeURIComponent(q)}&videoEmbeddable=true&key=${KEY}`);
    const d=await r.json();
    box.innerHTML=''; const arr=[];
    d.items.forEach(it=>{
        if(!it.id?.videoId) return;
        const s={id:it.id.videoId,title:it.snippet.title,thumb:it.snippet.thumbnails.medium?.url||''};
        arr.push(s);
        box.innerHTML+=`<div class="card" onclick="playThis(arr,${arr.length-1})">
            <img src="${s.thumb}"><h3>${s.title}</h3>
            <div class="play"><span class="material-icons-round">play_arrow</span></div>
        </div>`;
    });
}

function toggleFilter(){
    if(currentMode==='songs'){
        currentMode='playlists';
        document.querySelector('.filter').textContent='播放清單 ∨';
        showPlaylists();
    } else {
        currentMode='songs';
        document.querySelector('.filter').textContent='歌曲 ∨';
        loadRecommend();
    }
}
function showPlaylists(){
    document.getElementById('pageTitle').textContent='你的播放清單';
    const box=document.getElementById('list'); box.innerHTML='';
    if(playlists.length===0){
        box.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:80px;color:#888;">還沒有播放清單<br>搜尋歌曲後長按加入哦～</div>';
        return;
    }
    playlists.forEach((pl,i)=>{
        box.innerHTML+=`<div class="card" onclick="playThis(pl.songs)">
            <img src="${pl.songs[0]?.thumb||''}"><h3>${pl.name} (${pl.songs.length}首)</h3>
            <div class="play"><span class="material-icons-round">play_arrow</span></div>
        </div>`;
    });
}

// 簡單播放清單管理（長按卡片加入）
document.getElementById('list').addEventListener('contextmenu', e=>{
    e.preventDefault();
    const card = e.target.closest('.card');
    if(!card || currentMode!=='songs') return;
    const title = card.querySelector('h3').textContent;
    const img = card.querySelector('img').src;
    const id = card.onclick.toString().match(/'([a-zA-Z0-9_-]{11})'/)[1];
    const name = prompt('加入哪個播放清單？', playlists[0]?.name||'我的最愛');
    if(!name) return;
    let pl = playlists.find(p=>p.name===name);
    if(!pl){ pl={name,songs:[]}; playlists.push(pl); }
    pl.songs.push({id,title,thumb:img});
    localStorage.setItem('fm_playlists',JSON.stringify(playlists));
    alert('已加入「'+name+'」');
});

loadRecommend();
</script>
</body>
</html>