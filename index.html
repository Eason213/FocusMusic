<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FocusMusic</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#000;color:#fff;font-family:system-ui;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
header{height:70px;background:#111;display:flex;align-items:center;padding:0 16px;gap:12px;position:relative;z-index:10;}
header h1{color:#1ed760;font-size:28px;font-weight:900;}
#search{flex:1;background:#fff;color:#000;padding:12px 16px;border-radius:30px;font-size:16px;outline:none;}
main{flex:1;overflow-y:auto;padding:20px 16px 100px;background:#000;}
h1{font-size:32px;font-weight:900;margin-bottom:20px;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px;}
.card{background:#1a1a1a;border-radius:12px;overflow:hidden;position:relative;cursor:pointer;}
.card img{width:100%;aspect-ratio:1;object-fit:cover;}
.card h3{padding:12px;font-size:14px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.play{position:absolute;right:12px;bottom:68px;width:56px;height:56px;background:#1ed760;color:#000;
    border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0;transition:.3s;}
.card:hover .play{opacity:1;}
#player{position:fixed;bottom:0;left:0;right:0;height:90px;background:#000;border-top:1px solid #333;
    display:flex;align-items:center;padding:0 16px;z-index:999;}
#player img{width:56px;height:56px;border-radius:8px;}
#title{font-weight:600;margin-left:12px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.controls button{background:none;border:none;color:#fff;cursor:pointer;font-size:32px;margin:0 12px;}
#playBtn{background:#1ed760;color:#000;width:56px;height:56px;border-radius:50%;font-size:36px!important;}
#shuffleBtn{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:#1ed760;color:#000;
    padding:16px 36px;border-radius:50px;font-size:18px;font-weight:900;cursor:pointer;z-index:99;}
</style>
</head>
<body>

<header>
    <h1>FocusMusic</h1>
    <input type="text" id="search" placeholder="搜尋歌曲…" onkeypress="if(event.key==='Enter') search()">
</header>

<main>
    <h1 id="title">為你推薦</h1>
    <div class="grid" id="grid"></div>
</main>

<div id="shuffleBtn" onclick="shuffle()">隨機播放全部</div>

<div id="player">
    <img id="thumb" src="">
    <div id="title">準備播放</div>
    <div class="controls">
        <button onclick="prev()">skip_previous</button>
        <button id="playBtn" onclick="toggle()">play_arrow</button>
        <button onclick="next()">skip_next</button>
    </div>
</div>

<div id="yt" style="display:none;"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
const KEY = 'AIzaSyBpy0IZXf9kkkPh2FlO-UMTVXUSmNqqyTQ'; // ← 這裡換你的 YouTube API Key
let player, songs = [], current = -1;

// 強制一定會載入的播放器
function onYouTubeIframeAPIReady() {
    player = new YT.Player('yt', {
        height: '0', width: '0',
        playerVars: { autoplay: 1, controls: 0, playsinline: 1, rel: 0 },
        events: { 'onReady': onPlayerReady }
    });
}
function onPlayerReady() {
    loadRecommend(); // 載入完播放器後直接載推薦
}

// 播放核心（絕對穩）
function play(index) {
    current = index;
    const s = songs[index];
    document.getElementById('title').textContent = s.title;
    document.getElementById('thumb').src = s.thumb;
    player.loadVideoById(s.id);
    document.querySelector('#playBtn').innerHTML = 'pause';
}
function toggle() { player.getPlayerState() === 1 ? player.pauseVideo() : player.playVideo(); }
function next() { play((current + 1) % songs.length); }
function prev() { play(current <= 0 ? songs.length - 1 : current - 1); }
function shuffle() {
    const shuffled = [...songs].sort(() => Math.random() - 0.5);
    songs = shuffled;
    play(0);
}

// 載入推薦（一定成功）
async function loadRecommend() {
    document.getElementById('title').textContent = '為你推薦';
    const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&chart=mostPopular&videoCategoryId=10&regionCode=TW&maxResults=50&key=${KEY}`);
    const data = await res.json();
    songs = data.items.map(v => ({
        id: v.id,
        title: v.snippet.title,
        thumb: v.snippet.thumbnails.medium.url
    }));
    render(songs);
}

// 搜尋（一定成功）
async function search() {
    const q = document.getElementById('search').value.trim();
    if (!q) return;
    document.getElementById('title').textContent = '搜尋結果';
    const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=50&q=${encodeURIComponent(q)}&videoEmbeddable=true&key=${KEY}`);
    const data = await res.json();
    songs = data.items
        .filter(i => i.id?.videoId)
        .map(i => ({
            id: i.id.videoId,
            title: i.snippet.title,
            thumb: i.snippet.thumbnails.medium?.url || ''
        }));
    render(songs);
}

// 渲染卡片（最簡單的方式）
function render(list) {
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    list.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
            <img src="${s.thumb}">
            <h3>${s.title.substring(0, 40)}${s.title.length > 40 ? '…' : ''}</h3>
            <div class="play" onclick="play(${i})">play_arrow</div>
        `;
        grid.appendChild(div);
    });
}
</script>
</body>
</html>