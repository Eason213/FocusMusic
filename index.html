<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FocusMusic</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#000;color:#fff;font-family:system-ui;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
header{height:70px;background:#000;display:flex;align-items:center;padding:0 16px;gap:12px;position:relative;z-index:10;}
header h1{color:#1ed760;font-size:28px;font-weight:900;}
#search{flex:1;background:#333;color:#fff;padding:12px 20px;border-radius:30px;font-size:16px;outline:none;border:none;}
#filter{background:#1ed760;color:#000;padding:8px 16px;border-radius:20px;font-size:14px;font-weight:700;cursor:pointer;}
main{flex:1;overflow-y:auto;padding:20px 16px 100px;background:#000;}
h1{font-size:32px;font-weight:900;margin-bottom:20px;color:#fff;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:20px;}
.card{background:#1a1a1a;border-radius:12px;overflow:hidden;position:relative;cursor:pointer;transition:.2s;}
.card:hover{transform:scale(1.05);}
.card img{width:100%;aspect-ratio:1;object-fit:cover;border-radius:8px;}
.card h3{padding:12px;font-size:14px;font-weight:600;line-height:1.4;height:48px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
.play{position:absolute;right:12px;bottom:68px;width:56px;height:56px;background:#1ed760;color:#000;border-radius:50%;
    display:flex;align-items:center;justify-content:center;opacity:0;transition:.3s;font-size:28px;box-shadow:0 8px 20px rgba(0,0,0,0.6);}
.card:hover .play{opacity:1;}

/* 播放器完全重寫，永遠不會不見 */
#player{position:fixed;bottom:0;left:0;right:0;height:90px;background:#000;border-top:1px solid #333;
    display:flex;align-items:center;padding:0 16px;z-index:999;gap:16px;}
#player img{width:56px;height:56px;border-radius:8px;object-fit:cover;}
#nowTitle{font-weight:600;font-size:16px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.controls{display:flex;align-items:center;gap:20px;}
.controls button{background:none;border:none;color:#fff;cursor:pointer;font-size:36px;width:50px;height:50px;display:flex;align-items:center;justify-content:center;}
#playBtn{background:#1ed760;color:#000;border-radius:50%;font-size:40px!important;}
.progress{position:absolute;bottom:0;left:0;right:0;height:4px;background:#333;cursor:pointer;}
#bar{height:100%;width:0%;background:#1ed760;transition:width .1s;}
#shuffle{position:fixed;bottom:106px;left:50%;transform:translateX(-50%);background:#1ed760;color:#000;
    padding:16px 40px;border-radius:50px;font-size:18px;font-weight:900;cursor:pointer;z-index:99;}
</style>
</head>
<body>

<header>
    <h1>FocusMusic</h1>
    <input type="text" id="search" placeholder="搜尋歌曲…" onkeypress="if(event.key==='Enter') search()">
    <div id="filter" onclick="toggleMode()">歌曲</div>
</header>

<main>
    <h1 id="pageTitle">為你推薦</h1>
    <div class="grid" id="grid"></div>
</main>

<div id="shuffle" onclick="shufflePlay()">隨機播放全部</div>

<div id="player">
    <img id="thumb" src="" alt="">
    <div id="nowTitle">準備播放</div>
    <div class="controls">
        <button onclick="prev()">previous</button>
        <button id="playBtn" onclick="togglePlay()">play</button>
        <button onclick="next()">next</button>
    </div>
    <div class="progress" onclick="seek(event)"><div id="bar"></div></div>
</div>

<div id="yt" style="display:none;"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
const KEY = 'AIzaSyBpy0IZXf9kkkPh2FlO-UMTVXUSmNqqyTQ';
let player, songs = [], current = -1;
let mode = 'song'; // song or playlist
let playlists = JSON.parse(localStorage.getItem('fm_pl')||'[]');

function onYouTubeIframeAPIReady() {
    player = new YT.Player('yt', {
        playerVars: { autoplay:1, controls:0, playsinline:1, rel:0, fs:0 },
        events: {
            'onReady': () => { loadRecommend(); setInterval(updateProgress, 500); },
            'onStateChange': e => {
                document.getElementById('playBtn').innerHTML = e.data===1 ? 'pause' : 'play';
            }
        }
    });
}

function play(i) {
    current = i;
    const s = songs[i];
    document.getElementById('nowTitle').textContent = s.title;
    document.getElementById('thumb').src = s.thumb || '';
    player.loadVideoById(s.id);
}
function togglePlay() { player.getPlayerState()===1 ? player.pauseVideo() : player.playVideo(); }
function next() { play(current >= songs.length-1 ? 0 : current + 1); }
function prev() { play(current <= 0 ? songs.length-1 : current - 1); }
function seek(e) {
    const rect = e.currentTarget.getBoundingClientRect();
    const pos = (e.clientX - rect.left) / rect.width;
    player.seekTo(pos * player.getDuration());
}
function updateProgress() {
    if (!player.getDuration) return;
    document.getElementById('bar').style.width = (player.getCurrentTime() / player.getDuration() * 100) + '%';
}
function shufflePlay() {
    const arr = [...songs];
    for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    songs = arr;
    render(songs);
    play(0);
}

function render(list) {
    const g = document.getElementById('grid');
    g.innerHTML = '';
    list.forEach((item, i) => {
        const d = document.createElement('div');
        d.className = 'card';
        d.innerHTML = `
            <img src="${item.thumb}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIj48L3JlY3Q+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iNDAiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7wn5mDPC90ZXh0Pjwvc3ZnPg=='">
            <h3>${item.title.replace(/&/g,'&amp;').replace(/</g,'&lt;').substring(0,80)}</h3>
            <div class="play" onclick="event.stopPropagation();play(${i})">
                play
            </div>
        `;
        if (mode === 'song') d.onclick = () => play(i);
        else d.onclick = () => { songs = item.songs; render(item.songs); play(0); };
        g.appendChild(d);
    });
}

async function loadRecommend() {
    document.getElementById('pageTitle').textContent = '為你推薦';
    const r = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&chart=mostPopular&videoCategoryId=10&regionCode=TW&maxResults=50&key=${KEY}`);
    const d = await r.json();
    songs = d.items.map(v=>({id:v.id,title:v.snippet.title,thumb:v.snippet.thumbnails.medium.url}));
    render(songs);
}

async function search() {
    const q = document.getElementById('search').value.trim();
    if (!q) return;
    document.getElementById('pageTitle').textContent = '搜尋：'+q;
    const r = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=50&q=${encodeURIComponent(q)}&videoEmbeddable=true&key=${KEY}`);
    const d = await r.json();
    songs = d.items.filter(i=>i.id?.videoId).map(i=>({
        id:i.id.videoId,
        title:i.snippet.title,
        thumb:i.snippet.thumbnails.medium?.url||''
    }));
    render(songs);
}

function toggleMode() {
    mode = mode==='song' ? 'playlist' : 'song';
    document.getElementById('filter').textContent = mode==='song'?'歌曲':'播放清單';
    if (mode==='playlist') {
        document.getElementById('pageTitle').textContent = '你的播放清單';
        render(playlists.map(p=>({title:p.name+' ('+p.songs.length+')',thumb:p.songs[0]?.thumb||'',songs:p.songs})));
    } else loadRecommend();
}

// 長按加入播放清單
document.getElementById('grid').addEventListener('contextmenu', e=>{
    e.preventDefault();
    if(mode!=='song') return;
    const card = e.target.closest('.card');
    if(!card) return;
    const idx = Array.from(card.parentNode.children).indexOf(card);
    const song = songs[idx];
    const name = prompt('加入哪個播放清單？', playlists[0]?.name||'我的最愛');
    if(!name) return;
    let pl = playlists.find(p=>p.name===name);
    if(!pl){ pl={name,songs:[]}; playlists.push(pl); }
    pl.songs.push(song);
    localStorage.setItem('fm_pl',JSON.stringify(playlists));
    alert('已加入 '+name);
});

loadRecommend();
</script>
</body>
</html>