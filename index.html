<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Music Premium</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body,html{max-width:100vw;overflow-x:hidden;background:#000;color:#fff;font-family:-apple-system,system-ui,sans-serif;}
        #app{max-width:100vw;margin:0 auto;background:#000;padding-bottom:200px;position:relative;}

        /* 搜尋列 - 高級感 */
        #search-bar{padding:16px 14px 10px;background:#000;position:sticky;top:0;z-index:10;display:flex;gap:12px;align-items:center;}
        #search{flex:1;min-width:0;padding:16px 18px;background:rgba(255,255,255,0.08);border-radius:18px;color:#fff;font-size:18px;border:none;outline:none;backdrop-filter:blur(10px);}
        #search::placeholder{color:rgba(255,255,255,0.5);}
        #search-type{padding:16px 14px;background:rgba(255,255,255,0.08);color:#fff;border:none;border-radius:18px;font-size:16px;backdrop-filter:blur(10px);}
        #search-btn{background:#ff0033;color:#fff;border:none;border-radius:18px;width:60px;height:60px;font-size:26px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(255,0,51,0.3);}

        .controls{padding:12px 14px;display:flex;gap:12px;}
        .btn-big{padding:16px 20px;border-radius:18px;font-size:17px;font-weight:700;flex:1;backdrop-filter:blur(10px);}
        .btn-green{background:linear-gradient(135deg,#00d26a,#00ff88);box-shadow:0 8px 25px rgba(0,210,106,0.3);}
        .btn-red{background:linear-gradient(135deg,#ff0033,#ff3366);box-shadow:0 8px 25px rgba(255,0,51,0.3);}

        #tabs{display:flex;background:rgba(17,17,17,0.9);position:sticky;top:86px;z-index:9;backdrop-filter:blur(20px);}
        #tabs button{flex:1;padding:20px;font-size:18px;color:rgba(255,255,255,0.6);background:none;border:none;font-weight:600;}
        #tabs button.active{color:#ff0033;border-bottom:4px solid #ff0033;}

        .list{padding:8px 12px 20px;}
        .card{
            position:relative;
            background:linear-gradient(135deg,rgba(30,30,30,0.9),rgba(20,20,20,0.95));
            border-radius:20px;
            margin:16px 0;
            overflow:hidden;
            box-shadow:0 10px 30px rgba(0,0,0,0.6);
            border:1px solid rgba(255,255,255,0.05);
            backdrop-filter:blur(10px);
        }
        .card img{width:100%;height:200px;object-fit:cover;filter:brightness(0.9);}
        .card-info{padding:16px 70px 18px 18px;}
        .card-title{font-size:17px;font-weight:700;line-height:1.4;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}

        /* 頂級浮動按鈕 */
        .fab{
            position:absolute;
            width:56px;height:56px;
            border-radius:50%;
            display:flex;align-items:center;justify-content:center;
            font-size:26px;
            color:#fff;
            bottom:16px;
            z-index:10;
            box-shadow:0 8px 25px rgba(0,0,0,0.6);
            backdrop-filter:blur(10px);
        }
        .fab-play{background:linear-gradient(135deg,#ff0033,#ff3366);right:70px;box-shadow:0 8px 25px rgba(255,0,51,0.5);}
        .fab-fav{background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.2);right:14px;}

        /* 頂級播放器 */
        #player{
            position:fixed !important;
            bottom:0;left:0;right:0;
            background:linear-gradient(135deg,rgba(0,0,0,0.95),rgba(10,10,10,0.98));
            backdrop-filter:blur(30px);
            padding:24px 20px;
            border-top:1px solid rgba(255,255,255,0.1);
            z-index:9999 !important;
            box-shadow:0 -10px 40px rgba(0,0,0,0.8);
        }
        #now-playing{display:flex;align-items:center;gap:16px;margin-bottom:12px;}
        #now-thumb{width:64px;height:64px;border-radius:16px;object-fit:cover;box-shadow:0 8px 20px rgba(0,0,0,0.6);}
        #current-title{font-size:19px;font-weight:800;}
        #time-info{font-size:14px;color:rgba(255,255,255,0.7);display:flex;justify-content:space-between;margin-top:6px;}
        #progress-container{height:7px;background:rgba(255,255,255,0.15);border-radius:4px;margin:14px 0;overflow:hidden;position:relative;cursor:pointer;}
        #progress{height:100%;width:0%;background:linear-gradient(90deg,#ff0033,#ff6699);border-radius:4px;box-shadow:0 0 15px rgba(255,0,51,0.6);}
        #controls{display:flex;justify-content:center;align-items:center;gap:40px;margin-top:10px;}
        #controls button{color:#fff;font-size:52px;background:none;border:none;}
        #loopBtn.active{color:#ff0033 !important;}

        .hidden{display:none !important;}
    </style>
</head>
<body>
<div id="app">

    <div id="search-bar">
        <input type="text" id="search" placeholder="搜尋歌曲或播放清單…">
        <select id="search-type">
            <option value="video">歌曲</option>
            <option value="playlist">清單</option>
        </select>
        <button id="search-btn" onclick="search()">
            <span class="material-icons">search</span>
        </button>
    </div>

    <div class="controls hidden" id="page-controls">
        <button class="btn-big btn-green" onclick="playCurrentAll()">全部播放</button>
        <button class="btn-big btn-red" onclick="addCurrentToFav()">加入最愛</button>
    </div>

    <div id="tabs">
        <button class="active" onclick="switchTab('results')">搜尋</button>
        <button onclick="switchTab('favorites')">最愛</button>
        <button onclick="switchTab('history')">歷史</button>
    </div>

    <div class="list" id="results"></div>
    <div class="list hidden" id="favorites"></div>
    <div class="list hidden" id="history"></div>

    <div id="player">
        <div id="now-playing">
            <img id="now-thumb" src="">
            <div style="flex:1">
                <div id="current-title">準備播放</div>
                <div id="time-info">
                    <span id="current-time">0:00</span>
                    <span id="total-time">0:00</span>
                </div>
            </div>
        </div>
        <div id="progress-container" onclick="seek(event)">
            <div id="progress"></div>
        </div>
        <div id="controls">
            <button id="loopBtn" onclick="toggleLoop()"><span class="material-icons">repeat</span></button>
            <button onclick="prevTrack()"><span class="material-icons">skip_previous</span></button>
            <button id="playBtn" onclick="togglePlay()"><span class="material-icons">play_arrow</span></button>
            <button onclick="nextTrack()"><span class="material-icons">skip_next</span></button>
        </div>
    </div>

</div>

<div id="youtube-player"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    const API_KEY = 'AIzaSyBpy0IZXf9kkkPh2FlO-UMTVXUSmNqqyTQ';

    let player, tracks = [], idx = -1, loop = false;
    let currentTab = 'results';
    let resultsSongs = [], favorites = JSON.parse(localStorage.getItem('fav')||'[]'), history = JSON.parse(localStorage.getItem('hist')||'[]');

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('youtube-player', {
            playerVars: { playsinline:1, controls:0, rel:0 },
            events: { 
                'onReady': ()=>setInterval(updateProgress, 500),
                'onStateChange': e=>{
                    document.querySelector('#playBtn span').textContent = e.data===1?'pause':'play_arrow';
                    if(e.data===0) loop ? playCurrent() : nextTrack();
                }
            }
        });
    }

    async function search() {
        const q = document.getElementById('search').value.trim();
        const type = document.getElementById('search-type').value;
        if(!q) return;

        resultsSongs = [];
        const c = document.getElementById('results'); c.innerHTML = '';

        if(type==='playlist'){
            const res = await fetch(`https://www.googleapis.com/youtube/v3/search?key=${API_KEY}&q=${encodeURIComponent(q)}&part=snippet&type=playlist&maxResults=8`);
            const data = await res.json();
            for(let item of data.items){
                const plRes = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?key=${API_KEY}&playlistId=${item.id.playlistId}&part=snippet&maxResults=50`);
                const plData = await plRes.json();
                plData.items.forEach(p=>{
                    if(p.snippet.resourceId?.videoId && p.snippet.title!=='Private video'){
                        const song = {id:p.snippet.resourceId.videoId, title:p.snippet.title, thumb:p.snippet.thumbnails?.medium?.url || p.snippet.thumbnails?.default?.url};
                        resultsSongs.push(song);
                        addCard(c, song);
                    }
                });
            }
        } else {
            const res = await fetch(`https://www.googleapis.com/youtube/v3/search?key=${API_KEY}&q=${encodeURIComponent(q)}&part=snippet&type=video&maxResults=30&videoEmbeddable=true`);
            const data = await res.json();
            data.items.forEach(item=>{
                if(item.id?.videoId){
                    const song = {id:item.id.videoId, title:item.snippet.title, thumb:item.snippet.thumbnails?.medium?.url};
                    resultsSongs.push(song);
                    addCard(c, song);
                }
            });
        }
        document.getElementById('page-controls').classList.remove('hidden');
    }

    function addCard(c, s){
        const div = document.createElement('div');
        div.className='card';
        div.innerHTML = `
            <img src="${s.thumb||'https://i.ytimg.com/vi/'+s.id+'/mqdefault.jpg'}">
            <div class="card-info">
                <div class="card-title">${s.title}</div>
            </div>
            <div class="fab fab-play" onclick="playSong('${s.id}','${s.title.replace(/'/g,"\\'")}','${s.thumb||''}')">
                <span class="material-icons">play_arrow</span>
            </div>
            <div class="fab fab-fav" onclick="addToFavorites('${s.id}','${s.title.replace(/'/g,"\\'")}')">
                <span class="material-icons">favorite</span>
            </div>
        `;
        c.appendChild(div);
    }

    function playSong(id,title,thumb){ tracks=[{id,title,thumb}]; idx=0; playCurrent(); }
    function playCurrentAll(){
        let list = currentTab==='results'?resultsSongs:currentTab==='favorites'?favorites:history;
        if(!list.length) return;
        tracks = list.map(s=>({id:s.id,title:s.title,thumb:s.thumb}));
        idx=0; playCurrent();
    }
    function addCurrentToFav(){
        let list = currentTab==='results'?resultsSongs:favorites;
        list.forEach(s=>addToFavorites(s.id,s.title));
    }
    function addToFavorites(id,title){
        if(!favorites.some(f=>f.id===id)){
            favorites.push({id,title,thumb:''});
            localStorage.setItem('fav',JSON.stringify(favorites));
            if(currentTab==='favorites') renderFavorites();
        }
    }
    function playCurrent(){
        const s=tracks[idx];
        document.getElementById('current-title').textContent=s.title;
        document.getElementById('now-thumb').src=s.thumb||'https://i.ytimg.com/vi/'+s.id+'/mqdefault.jpg';
        addToHistory(s.id,s.title);
        player.loadVideoById(s.id);
        document.querySelector('#playBtn span').textContent='pause';
    }
    function nextTrack(){ idx=(idx+1)%tracks.length; playCurrent(); }
    function prevTrack(){ idx=idx<=0?tracks.length-1:idx-1; playCurrent(); }
    function togglePlay(){ player.getPlayerState()===1?player.pauseVideo():player.playVideo(); }
    function toggleLoop(){ loop=!loop; document.getElementById('loopBtn').classList.toggle('active',loop); }

    function updateProgress(){
        if(!player?.getDuration) return;
        const cur=player.getCurrentTime()||0, dur=player.getDuration()||0;
        document.getElementById('progress').style.width=(cur/dur*100)+'%';
        document.getElementById('current-time').textContent=formatTime(cur);
        document.getElementById('total-time').textContent=formatTime(dur);
    }
    function formatTime(t){ const m=Math.floor(t/60), s=Math.floor(t%60); return `${m}:${s<10?'0'+s:s}`; }
    function seek(e){
        const rect=e.currentTarget.getBoundingClientRect();
        const pos=(e.clientX-rect.left)/rect.width;
        player.seekTo(pos*player.getDuration());
    }
    function addToHistory(id,title){
        if(!history.some(h=>h.id===id)){
            history.unshift({id,title});
            if(history.length>100) history.pop();
            localStorage.setItem('hist',JSON.stringify(history));
            if(currentTab==='history') renderHistory();
        }
    }
    function renderFavorites(){ const c=document.getElementById('favorites'); c.innerHTML=''; favorites.forEach(s=>addCard(c,s)); }
    function renderHistory(){ const c=document.getElementById('history'); c.innerHTML=''; history.forEach(s=>addCard(c,s)); }

    function switchTab(t){
        currentTab=t;
        document.querySelectorAll('#tabs button').forEach(b=>b.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.list, #page-controls').forEach(el=>el.classList.add('hidden'));
        document.getElementById(t).classList.remove('hidden');
        document.getElementById('page-controls').classList.remove('hidden');
        if(t==='favorites') renderFavorites();
        if(t==='history') renderHistory();
    }

    if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>