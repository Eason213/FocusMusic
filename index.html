<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FocusMusic</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#000;color:#fff;font-family:system-ui;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
header{height:70px;background:#000;display:flex;align-items:center;padding:0 16px;gap:12px;position:relative;z-index:10;}
header h1{color:#1ed760;font-size:28px;font-weight:900;}
#search{flex:1;background:#222;color:#fff;padding:12px 20px;border-radius:30px;font-size:16px;outline:none;border:none;}
#filter{background:#1ed760;color:#000;padding:8px 16px;border-radius:20px;font-size:14px;font-weight:700;cursor:pointer;}
main{flex:1;overflow-y:auto;padding:20px 16px 100px;}
h1{font-size:32px;font-weight:900;margin-bottom:20px;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:20px;}
.card{background:#1a1a1a;border-radius:12px;overflow:hidden;position:relative;cursor:pointer;transition:.25s;}
.card:hover{transform:scale(1.06);}
.card img{width:100%;aspect-ratio:1;object-fit:cover;border-radius:8px;}
.card h3{padding:12px;font-size:14px;font-weight:600;line-height:1.4;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
.play{position:absolute;right:16px;bottom:70px;width:60px;height:60px;background:#1ed760;color:#000;border-radius:50%;
    display:flex;align-items:center;justify-content:center;opacity:0;transition:.3s;font-size:34px;box-shadow:0 8px 25px rgba(0,0,0,0.7);}
.card:hover .play{opacity:1;}
#player{position:fixed;bottom:0;left:0;right:0;height:90px;background:#000;border-top:1px solid #333;
    display:flex;align-items:center;padding:0 20px;z-index:999;gap:16px;}
#player img{width:56px;height:56px;border-radius:8px;}
#nowTitle{font-weight:600;font-size:16px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.controls button{background:#191919;color:#fff;width:52px;height:52px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:30px;}
#playBtn{background:#1ed760;color:#fff;width:68px;height:68px;font-size:38px!important;}
.progress{position:absolute;bottom:0;left:0;right:0;height:4px;background:#333;cursor:pointer;}
#bar{height:100%;width:0%;background:#1ed760;transition:width .1s;}
#shuffle{position:fixed;bottom:106px;left:50%;transform:translateX(-50%);background:#1ed760;color:#000;
    padding:16px 40px;border-radius:50px;font-size:18px;font-weight:900;cursor:pointer;z-index:99;}
</style>
</head>
<body>

<header>
    <h1>FocusMusic</h1>
    <input type="text" id="search" placeholder="搜尋歌曲…" onkeypress="if(event.key==='Enter')search()">
    <div id="filter" onclick="toggleMode()">歌曲</div>
</header>

<main>
    <h1 id="pageTitle">為你推薦</h1>
    <div class="grid" id="grid">載入中…</div>
</main>

<div id="shuffle" onclick="shufflePlay()">隨機播放全部</div>

<div id="player">
    <img id="thumb" src="">
    <div id="nowTitle">準備播放</div>
    <div class="controls">
        <button onclick="prev()"><span class="material-icons-outlined">skip_previous</span></button>
        <button id="playBtn" onclick="togglePlay()"><span class="material-icons-outlined">play_arrow</span></button>
        <button onclick="next()"><span class="material-icons-outlined">skip_next</span></button>
    </div>
    <div class="progress" onclick="seek(event)"><div id="bar"></div></div>
</div>

<div id="yt" style="display:none;"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
// 把這行換成你自己的 Key（一定要開啟 YouTube Data API v3）
const KEY = 'AIzaSyBpy0IZXf9kkkPh2FlO-UMTVXUSmNqqyTQ'; // ← 這裡換成你的

let player, songs = [], current = -1;
let mode = 'song';

function onYouTubeIframeAPIReady() {
    player = new YT.Player('yt', {
        playerVars: { autoplay:1, controls:0, playsinline:1, rel:0 },
        events: {
            'onReady': () => {
                setInterval(updateProgress, 500);
                loadRecommend();
            },
            'onStateChange': e => {
                document.querySelector('#playBtn span').textContent = e.data===1 ? 'pause' : 'play_arrow';
            }
        }
    });
}

function play(i) {
    current = i;
    const s = songs[i];
    document.getElementById('nowTitle').textContent = s.title;
    document.getElementById('thumb').src = s.thumb;
    player.loadVideoById(s.id);
}
function togglePlay() { player.getPlayerState()===1 ? player.pauseVideo() : player.playVideo(); }
function next() { play(current >= songs.length-1 ? 0 : current+1); }
 prev() { play(current <= 0 ? songs.length-1 : current-1); }
function seek(e) {
    const rect = e.currentTarget.getBoundingClientRect();
    player.seekTo((e.clientX-rect.left)/rect.width * player.getDuration());
}
function updateProgress() {
    if(!player.getDuration) return;
    document.getElementById('bar').style.width = (player.getCurrentTime()/player.getDuration()*100)+'%';
}
function shufflePlay() {
    const a = [...songs];
    for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
    }
    songs = a;
    render(songs);
    play(0);
}

function render(arr) {
    const g = document.getElementById('grid');
    g.innerHTML = '';
    arr.forEach((s,i) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
            <img src="${s.thumb}" onerror="this.src='https://via.placeholder.com/200/222/888?text=♪'">
            <h3>${s.title.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</h3>
            <div class="play" onclick="event.stopPropagation();play(${i})">
                <span class="material-icons-outlined">play_arrow</span>
            </div>
        `;
        div.onclick = () => play(i);
        g.appendChild(div);
    });
}

async function loadRecommend() {
    document.getElementById('pageTitle').textContent = '為你推薦';
    try {
        const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&chart=mostPopular&videoCategoryId=10&regionCode=TW&maxResults=50&key=${KEY}`);
        if (!res.ok) throw new Error('API 錯誤');
        const d = await res.json();
        songs = d.items.map(v=>({id:v.id,title:v.snippet.title,thumb:v.snippet.thumbnails.medium.url}));
        render(songs);
    } catch(e) {
        document.getElementById('grid').innerHTML = `<div style="text-align:center;padding:50px;color:#f66;">載入失敗<br><br>請確認：<br>1. 已替換第 91 行的 KEY<br>2. Google Cloud 專案已開啟 YouTube Data API v3<br>3. API Key 有配額且未被停用</div>`;
    }
}

async function search() {
    const q = document.getElementById('search').value.trim();
    if(!q) return;
    document.getElementById('pageTitle').textContent = '搜尋結果';
    try {
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=50&q=${encodeURIComponent(q)}&videoEmbeddable=true&key=${KEY}`);
        const d = await res.json();
        songs = d.items.filter(x=>x.id?.videoId).map(x=>({
            id:x.id.videoId,
            title:x.snippet.title,
            thumb:x.snippet.thumbnails.medium?.url||''
        }));
        render(songs);
    } catch(e) {
        document.getElementById('grid').innerHTML = '<div style="color:#f66;text-align:center;padding:50px;">搜尋失敗，請檢查 API Key</div>';
    }
}

function toggleMode() {
    mode = mode==='song' ? 'playlist' : 'song';
    document.getElementById('filter').textContent = mode==='song'?'歌曲':'播放清單';
    // 播放清單功能先留著，之後再加
    if(mode==='playlist'){
        document.getElementById('grid').innerHTML = '<div style="text-align:center;padding:80px;color:#888;">播放清單功能開發中…</div>';
    }else loadRecommend();
}

// 啟動
onYouTubeIframeAPIReady();
</script>
</body>
</html>