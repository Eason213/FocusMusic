<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Music</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:-apple-system,sans-serif;background:#000;color:#fff;min-height:100vh;overflow-x:hidden;}
        #app{max-width:100vw;margin:0 auto;background:#000;padding-bottom:180px;position:relative;}

        #search-bar{padding:16px;background:#000;position:sticky;top:0;z-index:10;display:grid;grid-template-columns:1fr 100px 70px;gap:10px;align-items:center;}
        #search{padding:15px;background:#1a1a1a;border-radius:14px;color:#fff;font-size:18px;border:none;outline:none;}
        #search-type{padding:15px;background:#1a1a1a;color:#fff;border:none;border-radius:14px;font-size:16px;}
        #search-btn{background:#ff0000;color:#fff;border:none;border-radius:14px;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;}

        .controls{padding:12px 16px;display:flex;gap:12px;flex-wrap:wrap;}
        .btn-big{padding:14px 26px;border-radius:14px;font-size:17px;font-weight:600;}
        .btn-green{background:#00d26a;}
        .btn-red{background:#ff0000;}

        #tabs{display:flex;background:#111;position:sticky;top:88px;z-index:9;}
        #tabs button{flex:1;padding:18px;font-size:17px;color:#888;background:none;border:none;}
        #tabs button.active{color:#ff0000;border-bottom:4px solid #ff0000;}

        /* 關鍵：完全不超出螢幕的卡片設計 */
        .list{padding:0 12px 12px;}
        .card{
            display:flex;
            align-items:center;
            padding:16px;
            background:#111;
            border-radius:16px;
            margin:12px 4px 0;
            gap:12px;
            position:relative;
            overflow:hidden;
        }
        .card img{width:72px;height:72px;border-radius:12px;object-fit:cover;flex-shrink:0;}
        .card-info{flex:1;min-width:0;} /* 關鍵：讓文字能縮 */
        .card-title{font-size:16.5px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .card-actions{
            position:absolute;
            right:12px;
            top:50%;
            transform:translateY(-50%);
            display:flex;
            flex-direction:column;
            gap:10px;
            z-index:2;
        }
        .card-actions button{
            width:76px;
            padding:10px 6px;
            border-radius:12px;
            font-size:14px;
            white-space:nowrap;
        }
        .btn-play{background:#ff0000;color:#fff;}
        .btn-fav{background:#333;color:#fff;}

        #player{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.97);backdrop-filter:blur(20px);padding:20px 16px;border-top:1px solid #333;}
        #now-playing{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
        #now-thumb{width:56px;height:56px;border-radius:10px;object-fit:cover;background:#333;}
        #current-title{font-size:18px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        #time-info{font-size:14px;color:#aaa;display:flex;justify-content:space-between;margin-top:4px;}
        #progress-container{height:6px;background:#333;border-radius:3px;margin:12px 0;overflow:hidden;position:relative;cursor:pointer;}
        #progress{height:100%;width:0%;background:#ff0000;border-radius:3px;transition:width 0.2s;}
        #controls{display:flex;justify-content:center;align-items:center;gap:36px;margin-top:8px;}
        #controls button{color:#fff;font-size:48px;background:none;border:none;width:70px;height:70px;display:flex;align-items:center;justify-content:center;}
        #loopBtn.active{color:#ff0000;}

        .hidden{display:none !important;}
    </style>
</head>
<body>
<div id="app">

    <div id="search-bar">
        <input type="text" id="search" placeholder="搜尋歌曲或播放清單…">
        <select id="search-type">
            <option value="video">歌曲</option>
            <option value="playlist">清單</option>
        </select>
        <button id="search-btn" onclick="search()">Search</button>
    </div>

    <div class="controls hidden" id="page-controls">
        <button class="btn-big btn-green" onclick="playCurrentAll()">全部播放</button>
        <button class="btn-big btn-red" onclick="addCurrentToFav()">加入最愛</button>
        </div>

    <div id="tabs">
        <button class="active" onclick="switchTab('results')">搜尋</button>
        <button onclick="switchTab('favorites')">最愛</button>
        <button onclick="switchTab('history')">歷史</button>
    </div>

    <div class="list" id="results"></div>
    <div class="list hidden" id="favorites"></div>
    <div class="list hidden" id="history"></div>

    <div id="player">
        <div id="now-playing">
            <img id="now-thumb" src="" alt="">
            <div style="flex:1">
                <div id="current-title">準備播放</div>
                <div id="time-info">
                    <span id="current-time">0:00</span>
                    <span id="total-time">0:00</span>
                </div>
            </div>
        </div>
        <div id="progress-container" onclick="seek(event)">
            <div id="progress"></div>
        </div>
        <div id="controls">
            <button id="loopBtn" onclick="toggleLoop()"><span class="material-icons">repeat</span></button>
            <button onclick="prevTrack()"><span class="material-icons">skip_previous</span></button>
            <button id="playBtn" onclick="togglePlay()"><span class="material-icons">play_arrow</span></button>
            <button onclick="nextTrack()"><span class="material-icons">skip_next</span></button>
        </div>
    </div>

</div>

<div id="youtube-player"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    const API_KEY = 'AIzaSyBpy0IZXf9kkkPh2FlO-UMTVXUSmNqqyTQ';

    let player, tracks = [], idx = -1, loop = false;
    let currentTab = 'results';
    let resultsSongs = [], favorites = JSON.parse(localStorage.getItem('fav')||'[]'), history = JSON.parse(localStorage.getItem('hist')||'[]');

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('youtube-player', {
            playerVars: { playsinline:1, controls:0, rel:0 },
            events: { 
                'onReady': ()=>setInterval(updateProgress, 500),
                'onStateChange': e=>{
                    document.querySelector('#playBtn span').textContent = e.data===1?'pause':'play_arrow';
                    if(e.data===0) loop ? playCurrent() : nextTrack();
                }
            }
        });
    }

    async function search() {
        const q = document.getElementById('search').value.trim();
        const type = document.getElementById('search-type').value;
        if(!q) return;

        resultsSongs = [];
        const container = document.getElementById('results'); container.innerHTML = '';

        if(type==='playlist'){
            const res = await fetch(`https://www.googleapis.com/youtube/v3/search?key=${API_KEY}&q=${encodeURIComponent(q)}&part=snippet&type=playlist&maxResults=8`);
            const data = await res.json();
            for(let item of data.items){
                const plRes = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?key=${API_KEY}&playlistId=${item.id.playlistId}&part=snippet&maxResults=50`);
                const plData = await plRes.json();
                plData.items.forEach(p=>{
                    if(p.snippet.resourceId?.videoId && p.snippet.title!=='Private video'){
                        const song = {id: p.snippet.resourceId.videoId, title: p.snippet.title, thumb: p.snippet.thumbnails?.medium?.url || p.snippet.thumbnails?.default?.url};
                        resultsSongs.push(song);
                        addCard(container, song);
                    }
                });
            }
        } else {
            const res = await fetch(`https://www.googleapis.com/youtube/v3/search?key=${API_KEY}&q=${encodeURIComponent(q)}&part=snippet&type=video&maxResults=30&videoEmbeddable=true`);
            const data = await res.json();
            data.items.forEach(item=>{
                if(item.id?.videoId){
                    const song = {id: item.id.videoId, title: item.snippet.title, thumb: item.snippet.thumbnails?.medium?.url};
                    resultsSongs.push(song);
                    addCard(container, song);
                }
            });
        }
        document.getElementById('page-controls').classList.remove('hidden');
    }

    function addCard(container, song){
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
            <img src="${song.thumb||'https://i.ytimg.com/vi/'+song.id+'/mqdefault.jpg'}">
            <div class="card-info">
                <div class="card-title">${song.title}</div>
            </div>
            <div class="card-actions">
                <button class="btn-play" onclick="playSong('${song.id}','${song.title.replace(/'/g,"\\'")}','${song.thumb||''}')">播放</button>
                <button class="btn-fav" onclick="addToFavorites('${song.id}','${song.title.replace(/'/g,"\\'")}')">Heart</button>
            </div>`;
        container.appendChild(div);
    }

    function playSong(id, title, thumb){
        tracks = [{id, title, thumb}];
        idx = 0;
        playCurrent();
    }

    function playCurrentAll(){
        let list = currentTab==='results' ? resultsSongs : 
                   currentTab==='favorites' ? favorites : history;
        if(list.length===0) return;
        tracks = list.map(s=>({id:s.id, title:s.title, thumb:s.thumb}));
        idx = 0;
        playCurrent();
    }

    function addCurrentToFav(){
        const list = currentTab==='results' ? resultsSongs : favorites;
        list.forEach(s=>addToFavorites(s.id, s.title));
    }

    function addToFavorites(id, title){
        if(!favorites.some(f=>f.id===id)){
            favorites.push({id, title, thumb: ''});
            localStorage.setItem('fav', JSON.stringify(favorites));
            if(currentTab==='favorites') renderFavorites();
        }
    }

    function playCurrent(){
        const s = tracks[idx];
        document.getElementById('current-title').textContent = s.title;
        document.getElementById('now-thumb').src = s.thumb || 'https://i.ytimg.com/vi/'+s.id+'/mqdefault.jpg';
        addToHistory(s.id, s.title);
        player.loadVideoById(s.id);
        document.querySelector('#playBtn span').textContent = 'pause';
    }

    function nextTrack(){ idx = (idx + 1) % tracks.length; playCurrent(); }
    function prevTrack(){ idx = idx<=0 ? tracks.length-1 : idx-1; playCurrent(); }
    function togglePlay(){ player.getPlayerState()===1 ? player.pauseVideo() : player.playVideo(); }
    function toggleLoop(){ loop = !loop; document.getElementById('loopBtn').classList.toggle('active',loop); }

    function updateProgress(){
        if(!player?.getDuration) return;
        const cur = player.getCurrentTime()||0;
        const dur = player.getDuration()||0;
        document.getElementById('progress').style.width = (cur/dur*100)+'%';
        document.getElementById('current-time').textContent = formatTime(cur);
        document.getElementById('total-time').textContent = formatTime(dur);
    }
    function formatTime(t){ const m=Math.floor(t/60); const s=Math.floor(t%60); return `${m}:${s<10?'0'+s:s}`; }
    function seek(e){
        const rect = e.currentTarget.getBoundingClientRect();
        const pos = (e.clientX - rect.left)/rect.width;
        player.seekTo(pos * player.getDuration());
    }

    function addToHistory(id,title){
        if(!history.some(h=>h.id===id)){
            history.unshift({id,title});
            if(history.length>100) history.pop();
            localStorage.setItem('hist',JSON.stringify(history));
            if(currentTab==='history') renderHistory();
        }
    }

    function renderFavorites(){
        const c = document.getElementById('favorites'); c.innerHTML='';
        favorites.forEach(s=>addCard(c, s));
    }
    function renderHistory(){
        const c = document.getElementById('history'); c.innerHTML='';
        history.forEach(s=>addCard(c, s));
    }

    function switchTab(t){
        currentTab = t;
        document.querySelectorAll('#tabs button').forEach(b=>b.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.list, #page-controls').forEach(el=>el.classList.add('hidden'));
        document.getElementById(t).classList.remove('hidden');
        document.getElementById('page-controls').classList.remove('hidden');
        if(t==='favorites') renderFavorites();
        if(t==='history') renderHistory();
    }

    if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>