<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FocusMusic</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root{--green:#1ed760;--black:#121212;--dark:#181818;--gray:#282828;}
        *{margin:0;padding:0;box-sizing:border-box;}
        body,html{background:var(--black);color:#fff;font-family:system-ui,sans-serif;overflow:hidden;height:100vh;}
        #app{position:relative;height:100vh;}

        /* 頂部橫條 - 完全不擋字 */
        .top-bar{
            height:70px;background:rgba(0,0,0,0.9);backdrop-filter:blur(20px);
            position:fixed;top:0;left:0;right:0;z-index:999;
            display:flex;align-items:center;padding:0 20px;justify-content:space-between;
        }
        .top-bar h1{color:var(--green);font-size:34px;font-weight:900;margin-left:60px;} /* 留空間給漢堡 */
        #toggle-sidebar{
            position:fixed;left:16px;top:16px;width:44px;height:44px;background:rgba(255,255,255,0.1);
            border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:1000;
            cursor:pointer;backdrop-filter:blur(10px);
        }

        /* 側邊欄 */
        nav{
            width:260px;background:var(--black);position:fixed;left:0;top:0;bottom:0;overflow-y:auto;
            padding:80px 0 20px;z-index:998;transition:transform .35s cubic-bezier(0.4,0,0.2,1);
            transform:translateX(0);
        }
        nav.hidden{transform:translateX(-100%);}

        main{
            margin-top:70px;padding:20px 16px 110px;overflow-y:auto;height:calc(100vh - 70px);
            transition:margin-left .35s;
        }

        /* 手機最佳化 */
        @media (max-width:768px){
            .top-bar h1{font-size:28px;margin-left:56px;}
            main{padding:16px 12px 100px;}
            .grid{grid-template-columns:repeat(2,1fr);gap:16px;}
            .card img{border-radius:8px;}
            .card h3{font-size:14px;}
            .play-btn,.add-btn{width:50px;height:50px;bottom:70px;}
            .play-btn{right:70px;}
        }

        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:24px;}
        .card{background:var(--gray);border-radius:12px;overflow:hidden;position:relative;cursor:pointer;transition:.3s;}
        .card:hover{transform:translateY(-8px);background:#333;}
        .card img{width:100%;aspect-ratio:1;object-fit:cover;}
        .card-info{padding:12px;}
        .card h3{font-weight:700;font-size:15px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .card p{font-size:13px;color:#b3b3b3;margin-top:4px;}
        .play-btn,.add-btn{
            position:absolute;bottom:70px;width:56px;height:56px;border-radius:50%;
            display:flex;align-items:center;justify-content:center;opacity:0;
            transition:.3s ease;box-shadow:0 8px 25px rgba(0,0,0,0.6);
        }
        .play-btn{right:70px;background:var(--green);color:#000;}
        .add-btn{right:12px;background:rgba(255,255,255,0.15);}
        .card:hover .play-btn,.card:hover .add-btn{opacity:1;}

        /* 播放器 */
        #player{
            position:fixed;bottom:0;left:0;right:0;height:90px;background:var(--black);
            border-top:1px solid #333;display:flex;align-items:center;padding:0 16px;z-index:999;
        }
        .player-left{flex:1;display:flex;align-items:center;gap:12px;}
        .player-left img{width:56px;height:56px;border-radius:8px;}
        .player-center{flex:1.5;display:flex;flex-direction:column;align-items:center;gap:8px;}
        .player-controls{display:flex;align-items:center;gap:28px;}
        .player-controls button{background:none;border:none;color:#b3b3b3;cursor:pointer;font-size:28px;}
        #playBtn{background:var(--green);color:#000;width:48px;height:48px;border-radius:50%;font-size:32px!important;}
        #loopBtn.active{color:var(--green);}
        #loopBtn.single{color:#1ed760;opacity:0.7;}
        .progress-bar{height:4px;background:#404040;border-radius:2px;overflow:hidden;width:100%;cursor:pointer;}
        .progress-fill{height:100%;width:0%;background:#fff;transition:width .1s linear;}

        h1{font-size:42px;font-weight:900;margin:20px 0;}
        .refresh-btn{color:var(--green);font-size:14px;cursor:pointer;margin-left:12px;}
    </style>
</head>
<body>
<div id="app">
    <div class="top-bar">
        <div id="toggle-sidebar" onclick="document.getElementById('sidebar').classList.toggle('hidden')">
            <span class="material-icons-round">menu</span>
        </div>
        <h1>FocusMusic</h1>
        <div></div>
    </div>

    <nav id="sidebar">
        <div style="padding:0 24px;">
            <div class="nav-item active" onclick="showSection('home')"><span class="material-icons-round">home</span> 首頁</div>
            <div class="nav-item" onclick="document.getElementById('search').focus()"><span class="material-icons-round">search</span> 搜尋</div>
            <div class="nav-item" onclick="showSection('library')"><span class="material-icons-round">library_music</span> 你的音樂庫</div>
            <div style="height:20px;"></div>
            <div id="folder-list"></div>
            <button onclick="createFolder()" style="margin:20px 24px;padding:14px;background:rgba(255,255,255,0.1);border:none;border-radius:8px;width:calc(100%-48px);color:#fff;font-weight:700;">
                + 建立播放清單
            </button>
        </div>
    </nav>

    <main>
        <section id="home">
            <div style="display:flex;align-items:center;">
                <h1>為你推薦</h1>
                <span class="refresh-btn" onclick="loadTop50(true)">↻ 更新推薦</span>
            </div>
            <div class="grid" id="top50"></div>
            <h1 style="margin-top:50px;">你的播放清單</h1>
            <div class="grid" id="my-playlists"></div>
        </section>

        <section id="results" class="hidden">
            <h1>搜尋結果</h1>
            <div class="grid" id="search-results"></div>
        </section>

        <section id="library" class="hidden">
            <h1>播放清單</h1>
            <div class="grid" id="library-playlists"></div>
        </section>
    </main>

    <div id="player">
        <div class="player-left">
            <img id="now-thumb" src="">
            <div>
                <div id="current-title" style="font-weight:600;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">準備播放</div>
            </div>
        </div>
        <div class="player-center">
            <div class="player-controls">
                <button onclick="toggleLoopMode()" id="loopBtn"><span class="material-icons-round">repeat</span></button>
                <button onclick="prevTrack()"><span class="material-icons-round">skip_previous</span></button>
                <button id="playBtn" onclick="togglePlay()"><span class="material-icons-round">play_arrow</span></button>
                <button onclick="nextTrack()"><span class="material-icons-round">skip_next</span></button>
            </div>
            <div class="progress-bar" onclick="seek(event)"><div class="progress-fill" id="progress"></div></div>
        </div>
    </div>
</div>

<div id="youtube-player" class="hidden"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    const API_KEY = 'AIzaSyBpy0IZXf9kkkPh2FlO-UMTVXUSmNqqyTQ';
    let player, tracks = [], idx = -1;
    let loopMode = 0; // 0=無, 1=全部循環, 2=單曲循環
    let folders = JSON.parse(localStorage.getItem('focusFolders')||'[]');
    let lastPlayed = JSON.parse(localStorage.getItem('lastPlayed')||'[]');

    function onYouTubeIframeAPIReady(){
        player = new YT.Player('youtube-player',{playerVars:{playsinline:1,controls:0,rel:0},events:{
            'onReady':()=>setInterval(updateProgress,500),
            'onStateChange':e=>{
                document.querySelector('#playBtn span').textContent = e.data===1?'pause':'play_arrow';
                if(e.data===0){
                    if(loopMode===2) playCurrent();
                    else if(loopMode===1 || idx<tracks.length-1) nextTrack();
                }
            }
        }});
        loadTop50();
        renderPlaylists();
    }

    // 關鍵修復：正確傳遞播放清單
    window.playThisList = function(list, startIdx=0){
        tracks = list;
        idx = startIdx;
        playCurrent();
    }

    function playCurrent(){
        if(!tracks[idx]) return;
        const s = tracks[idx];
        document.getElementById('current-title').textContent = s.title;
        document.getElementById('now-thumb').src = s.thumb || `https://i.ytimg.com/vi/${s.id}/mqdefault.jpg`;
        player.loadVideoById(s.id);
        // 記錄播放紀錄用於推薦
        if(!lastPlayed.includes(s.id)) {
            lastPlayed.unshift(s.id);
            if(lastPlayed.length>50) lastPlayed.pop();
            localStorage.setItem('lastPlayed', JSON.stringify(lastPlayed));
        }
    }

    function nextTrack(){ if(tracks.length>1) idx = (idx+1) % tracks.length; playCurrent(); }
    function prevTrack(){ if(tracks.length>1) idx = idx<=0 ? tracks.length-1 : idx-1; playCurrent(); }
    function togglePlay(){ player.getPlayerState()===1 ? player.pauseVideo() : player.playVideo(); }
    function toggleLoopMode(){
        loopMode = (loopMode + 1) % 3;
        const btn = document.getElementById('loopBtn');
        btn.className = '';
        if(loopMode===1) btn.classList.add('active');
        if(loopMode===2) { btn.classList.add('active'); btn.innerHTML = '<span class="material-icons-round">repeat_one</span>'; }
        if(loopMode===0) btn.innerHTML = '<span class="material-icons-round">repeat</span>';
    }

    async function search(){
        const q = document.getElementById('search')?.value.trim();
        if(!q) return;
        showSection('results');
        const container = document.getElementById('search-results');
        container.innerHTML = '<div style="text-align:center;padding:100px;color:#666;">搜尋中…</div>';
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=30&q=${encodeURIComponent(q)}&videoEmbeddable=true&key=${API_KEY}`);
        const data = await res.json();
        container.innerHTML = '';
        const results = [];
        data.items.forEach(item=>{
            if(item.id?.videoId){
                const song = {id:item.id.videoId, title:item.snippet.title, thumb:item.snippet.thumbnails.medium?.url};
                results.push(song);
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `<img src="${song.thumb}">
                    <div class="card-info"><h3>${song.title}</h3><p>${item.snippet.channelTitle}</p></div>
                    <div class="play-btn" onclick="playThisList([${results.map(s=>`{id:'${s.id}',title:\`${s.title}\`,thumb:'${s.thumb}'}`).join(',')}], ${results.length-1})">
                        <span class="material-icons-round">play_arrow</span>
                    </div>`;
                container.appendChild(div);
            }
        });
    }

    async function loadTop50(forceRefresh=false){
        const container = document.getElementById('top50');
        if(!forceRefresh && container.innerHTML) return;
        container.innerHTML = '<div style="text-align:center;padding:80px;color:#666;">載入中…</div>';
        // 簡單用你最近聽過的 + 熱門
        const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&chart=mostPopular&videoCategoryId=10&regionCode=TW&maxResults=20&key=${API_KEY}`);
        const data = await res.json();
        container.innerHTML = '';
        data.items.forEach(v=>{
            const div = document.createElement('div');
            div.className='card';
            div.innerHTML = `<img src="${v.snippet.thumbnails.medium.url}">
                <div class="card-info"><h3>${v.snippet.title.substr(0,40)}…</h3></div>
                <div class="play-btn" onclick="playThisList([{id:'${v.id}',title:\`${v.snippet.title.replace(/`/g,'\\`')}\`,thumb:'${v.snippet.thumbnails.medium.url}'}])">
                    <span class="material-icons-round">play_arrow</span>
                </div>`;
            container.appendChild(div);
        });
    }

    // 播放清單完整支援
    function createFolder(){
        const name = prompt('播放清單名稱');
        if(name){ folders.push({name,songs:[]}); saveAndRender(); }
    }
    function saveAndRender(){ localStorage.setItem('focusFolders',JSON.stringify(folders)); renderPlaylists(); }
    function renderPlaylists(){
        const containers = ['folder-list','my-playlists','library-playlists'];
        containers.forEach(id=>{
            const el = document.getElementById(id);
            if(!el) return;
            el.innerHTML = folders.map((f,i)=>`
                <div class="nav-item" onclick="openPlaylist(${i})" style="padding:12px 24px;">
                    <span class="material-icons-round">queue_music</span> ${f.name} <small>(${f.songs.length})</small>
                </div>
            `).join('');
        });
        document.getElementById('my-playlists').innerHTML = folders.map(f=>`
            <div class="card" onclick="playThisList(${JSON.stringify(f.songs)})">
                <img src="${f.songs[0]?.thumb||'https://i.imgur.com/8z6Q7vJ.png'}">
                <div class="card-info"><h3>${f.name}</h3><p>${f.songs.length}首</p></div>
                <div class="play-btn"><span class="material-icons-round">play_arrow</span></div>
            </div>
        `).join('');
    }
    function openPlaylist(i){
        const pl = folders[i];
        tracks = pl.songs;
        idx = 0;
        playCurrent();
        showSection('home');
    }

    function showSection(s){
        document.querySelectorAll('section').forEach(el=>el.classList.add('hidden'));
        document.getElementById(s).classList.remove('hidden');
        if(s==='home') loadTop50();
    }

    function updateProgress(){
        if(!player?.getDuration) return;
        const cur = player.getCurrentTime()||0, dur = player.getDuration()||0;
        document.getElementById('progress').style.width = (cur/dur*100)+'%';
    }
    function seek(e){
        const rect = e.currentTarget.getBoundingClientRect();
        const pos = (e.clientX - rect.left) / rect.width;
        player.seekTo(pos * player.getDuration());
    }

    // 啟動
    renderPlaylists();
    if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>